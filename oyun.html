<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dr. √ñzlem Ko≈üuyor: Final üèÉ‚Äç‚ôÄÔ∏è</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Poppins:wght@600;900&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        /* --- RESET VE TEMEL --- */
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: #333; overflow: hidden; font-family: 'Poppins', sans-serif;
            touch-action: none; /* Mobilde kaydƒ±rmayƒ± kilitler */
        }

        /* Oyun Alanƒ± Arka Planƒ± (CSS ile - Performans ƒ∞√ßin) */
        #gameWrapper {
            position: relative; width: 100%; height: 100vh;
            background: linear-gradient(180deg, #87CEEB 0%, #B3E5FC 100%);
            display: flex; justify-content: center; align-items: center;
        }

        canvas { 
            display: block; 
            max-width: 100%; max-height: 100%; 
            /* PC'de √ßok yayƒ±lmasƒ±n diye sƒ±nƒ±r koyuyoruz */
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        /* --- ARAY√úZ (HUD) --- */
        .ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 10;
        }

        /* √úst Bilgi √áubuƒüu */
        .top-bar {
            position: absolute; top: 15px; left: 15px; right: 15px;
            display: flex; justify-content: space-between; align-items: flex-start;
            pointer-events: auto;
        }

        .stats { display: flex; flex-direction: column; gap: 8px; }

        .hud-box {
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 15px; border-radius: 30px;
            border: 3px solid #333; color: #333;
            font-size: 0.9rem; font-weight: 900;
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
            display: flex; align-items: center; gap: 8px; width: fit-content;
        }

        #btnPause {
            width: 45px; height: 45px; border-radius: 50%;
            background: #fff; border: 3px solid #333;
            font-size: 1.2rem; display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 4px 0 rgba(0,0,0,0.1);
            transition: transform 0.1s;
        }
        #btnPause:active { transform: scale(0.9); }

        /* Lider Tablosu */
        #leaderboard {
            position: absolute; top: 80px; right: 15px;
            background: rgba(255, 255, 255, 0.9); border: 3px solid #4facfe;
            border-radius: 15px; padding: 10px; width: 160px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        #leaderboard h3 {
            margin: 0 0 5px 0; text-align: center; font-size: 0.8rem; color: #0072ff;
            border-bottom: 2px dashed #ccc;
        }
        .lb-row { font-size: 0.75rem; font-weight: bold; display: flex; justify-content: space-between; margin-bottom: 2px; }
        .lb-row:nth-child(2) { color: #d35400; }

        /* --- MEN√úLER --- */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 100;
            display: flex; align-items: center; justify-content: center;
            pointer-events: auto;
        }
        .hidden { display: none !important; }

        .panel {
            background: #fff; padding: 25px; width: 90%; max-width: 380px;
            border-radius: 25px; border: 5px solid #333;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); text-align: center;
        }

        h1 { font-family: 'Fredoka One', cursive; font-size: 1.8rem; color: #333; margin-bottom: 15px; }
        p { margin-bottom: 15px; color: #555; font-size: 0.9rem; }

        /* Butonlar */
        .btn {
            background: linear-gradient(180deg, #4facfe 0%, #00f2fe 100%);
            border: 3px solid #333; padding: 12px; border-radius: 50px;
            font-size: 1rem; font-weight: 900; color: #fff; cursor: pointer;
            width: 100%; margin-top: 10px; box-shadow: 0 5px 0 #0056b3;
            transition: transform 0.1s; text-transform: uppercase;
        }
        .btn:active { transform: translateY(3px); box-shadow: 0 2px 0 #0056b3; }
        .btn-shop { background: linear-gradient(180deg, #ff9966 0%, #ff5e62 100%); box-shadow: 0 5px 0 #c0392b; }
        .btn-shop:active { transform: translateY(3px); box-shadow: 0 2px 0 #c0392b; }
        .btn-red { background: #ff4757; box-shadow: 0 5px 0 #c0392b; }
        .btn-close { width: auto; padding: 8px 30px; margin: 15px auto 0; background: #555; box-shadow: 0 5px 0 #222; }

        input {
            width: 100%; padding: 10px; font-size: 1.1rem; border: 3px solid #ddd;
            border-radius: 10px; margin-bottom: 15px; text-align: center;
            font-weight: bold; font-family: 'Poppins', sans-serif; outline: none;
        }
        input:focus { border-color: #4facfe; }

        /* Maƒüaza Grid */
        .shop-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
            max-height: 250px; overflow-y: auto; padding: 5px;
        }
        .shop-item {
            border: 3px solid #eee; border-radius: 15px; padding: 10px 5px;
            cursor: pointer; display: flex; flex-direction: column; align-items: center;
            transition: 0.1s; background: #fff;
        }
        .shop-item:active { transform: scale(0.95); }
        .shop-item.selected { border-color: #27ae60; background: #e8f5e9; border-width: 3px; }
        .shop-item.locked { opacity: 0.5; filter: grayscale(1); }
        .item-icon { font-size: 2rem; margin-bottom: 5px; }
        .item-price { font-size: 0.75rem; font-weight: bold; background: #eee; padding: 2px 6px; border-radius: 8px; color: #555; }
        .item-owned { font-size: 0.7rem; color: #27ae60; font-weight: 900; display: none; }
        .shop-item.owned .item-price { display: none; }
        .shop-item.owned .item-owned { display: block; }

        /* Efekt */
        #celebration {
            position: absolute; top: 30%; left: 50%; transform: translate(-50%, -50%);
            font-family: 'Fredoka One', cursive; font-size: 3rem; color: #FFD700;
            text-shadow: 0 5px 0 rgba(0,0,0,0.2); pointer-events: none; z-index: 50;
            animation: pop 0.5s;
        }
        @keyframes pop { from{transform:translate(-50%,-50%) scale(0);} to{transform:translate(-50%,-50%) scale(1);} }

    </style>
</head>
<body>

    <div id="gameWrapper">
        <canvas id="gameCanvas"></canvas>

        <div class="ui-layer">
            <div class="top-bar">
                <div class="stats">
                    <div class="hud-box">üë§ <span id="dispName">Misafir</span></div>
                    <div class="hud-box" style="color:#0072ff">‚ö° <span id="dispScore">0</span></div>
                    <div class="hud-box" style="color:#27ae60">üíµ <span id="dispMoney">0</span></div>
                </div>
                <div id="btnPause" onclick="Game.togglePause()">‚è∏Ô∏è</div>
            </div>

            <div id="leaderboard">
                <h3>üèÜ Lƒ∞DERLER</h3>
                <div id="lbContent">Y√ºkleniyor...</div>
            </div>
        </div>

        <div id="celebration" class="hidden">100 PUAN! üéâ</div>

        <div id="screenName" class="screen">
            <div class="panel">
                <h1>Dr. √ñzlem Ko≈üuyor</h1>
                <p>Sƒ±ralamaya girmek i√ßin ismini yaz:</p>
                <input type="text" id="inpName" placeholder="Adƒ±n ne?" maxlength="12">
                <button class="btn" onclick="UI.submitName()">KAYDET VE Gƒ∞R</button>
            </div>
        </div>

        <div id="screenMenu" class="screen hidden">
            <div class="panel">
                <h1>HAZIRLAN!</h1>
                <p>
                    <b>PC:</b> Bo≈üluk (Zƒ±pla) / A≈üaƒüƒ± Ok (Eƒüil)<br>
                    <b>Mobil:</b> Dokun (Zƒ±pla) / Kaydƒ±r (Eƒüil)<br>
                    Paralarƒ± topla, karakterleri a√ß!
                </p>
                <button class="btn" onclick="Game.start()">KO≈ûMAYA BA≈ûLA üèÉ‚Äç‚ôÄÔ∏è</button>
                <button class="btn btn-shop" onclick="UI.openShop()">üè™ MAƒûAZA</button>
            </div>
        </div>

        <div id="screenShop" class="screen hidden">
            <div class="panel">
                <h1>MAƒûAZA</h1>
                <div style="margin-bottom:10px; color:#27ae60; font-weight:bold;">
                    BAKƒ∞YE: üíµ <span id="shopBalance">0</span>
                </div>
                <div class="shop-grid" id="shopGrid"></div>
                <button class="btn btn-close" onclick="UI.showScreen('screenMenu')">KAPAT</button>
            </div>
        </div>

        <div id="screenPause" class="screen hidden">
            <div class="panel">
                <h1>DURAKLATILDI</h1>
                <button class="btn" onclick="Game.togglePause()">DEVAM ET ‚ñ∂Ô∏è</button>
                <button class="btn btn-red" onclick="location.reload()">√áIKI≈û</button>
            </div>
        </div>

        <div id="screenOver" class="screen hidden">
            <div class="panel">
                <h1 style="color:#ff4757">YANDIN!</h1>
                <p>SKOR: <span id="endScore" style="font-size:1.5rem; color:#0072ff; font-weight:bold;">0</span></p>
                <p>KAZAN√á: <span id="endMoney" style="font-size:1.2rem; color:#27ae60; font-weight:bold;">0</span> üíµ</p>
                <button class="btn" onclick="UI.showScreen('screenMenu')">MEN√úYE D√ñN</button>
            </div>
        </div>
    </div>

    <script>
        // --- AYARLAR ---
        const DB_KEY = "dr_ozlem_final_fix";
        const FIREBASE_CONF = {
            apiKey: "AIzaSyBHejjQe2dHnwDYES3Qd30HKO94-_D5lVA",
            authDomain: "ask-oyunu-5d368.firebaseapp.com",
            databaseURL: "https://ask-oyunu-5d368-default-rtdb.firebaseio.com",
            projectId: "ask-oyunu-5d368",
            storageBucket: "ask-oyunu-5d368.firebasestorage.app",
            messagingSenderId: "550862375128",
            appId: "1:550862375128:web:fb49cef5e3c5440d996fad",
            measurementId: "G-T1GCW04QD0"
        };

        // --- OYUNCU VERƒ∞Sƒ∞ ---
        const Data = {
            name: "Misafir", money: 0,
            chars: [
                { id:0, icon:"üë©‚Äç‚öïÔ∏è", price:0, owned:true },
                { id:1, icon:"üëÆ‚Äç‚ôÄÔ∏è", price:50, owned:false },
                { id:2, icon:"üïµÔ∏è‚Äç‚ôÄÔ∏è", price:150, owned:false },
                { id:3, icon:"üßü‚Äç‚ôÄÔ∏è", price:300, owned:false },
                { id:4, icon:"üßô‚Äç‚ôÄÔ∏è", price:500, owned:false },
                { id:5, icon:"ü§ñ", price:1000, owned:false }
            ],
            selected: 0,
            save: function() {
                localStorage.setItem(DB_KEY, JSON.stringify(this));
                UI.update();
            },
            load: function() {
                const raw = localStorage.getItem(DB_KEY);
                if(raw) {
                    const d = JSON.parse(raw);
                    this.name = d.name || "Misafir";
                    this.money = d.money || 0;
                    if(d.chars) this.chars = d.chars;
                    this.selected = d.selected || 0;
                }
                UI.update();
            },
            getChar: function() { return this.chars.find(c => c.id === this.selected).icon; }
        };

        // --- FIREBASE BA≈ûLAT ---
        try {
            firebase.initializeApp(FIREBASE_CONF);
            const db = firebase.database();
            db.ref('runner_scores_final_v4').orderByChild('score').limitToLast(3).on('value', snap => {
                const list = document.getElementById('lbContent');
                list.innerHTML = "";
                let arr = [];
                snap.forEach(c => arr.push(c.val()));
                arr.reverse().forEach((s, i) => {
                    list.innerHTML += `<div class="lb-row"><span>#${i+1} ${s.name}</span><span>${s.score}</span></div>`;
                });
            });
        } catch(e) {}

        function sendScore(score) {
            if(typeof firebase !== 'undefined' && score > 0) {
                firebase.database().ref('runner_scores_final_v4').push({
                    name: Data.name, score: score, date: Date.now()
                });
            }
        }

        // --- UI KONTROL ---
        const UI = {
            screens: document.querySelectorAll('.screen'),
            showScreen: function(id) {
                this.screens.forEach(s => s.classList.add('hidden'));
                if(id) document.getElementById(id).classList.remove('hidden');
            },
            update: function() {
                document.getElementById('dispName').innerText = Data.name;
                document.getElementById('dispMoney').innerText = Data.money;
                document.getElementById('shopBalance').innerText = Data.money;
            },
            submitName: function() {
                const val = document.getElementById('inpName').value.trim();
                if(!val) return alert("ƒ∞sim yaz!");
                Data.name = val; Data.save(); this.showScreen('screenMenu');
            },
            openShop: function() {
                this.showScreen('screenShop');
                const grid = document.getElementById('shopGrid');
                grid.innerHTML = "";
                Data.chars.forEach(c => {
                    const div = document.createElement('div');
                    div.className = `shop-item ${c.owned ? 'owned' : ''} ${Data.selected === c.id ? 'selected' : ''}`;
                    if(!c.owned && Data.money < c.price) div.classList.add('locked');
                    div.innerHTML = `<div class="item-icon">${c.icon}</div><div class="item-price">üíµ ${c.price}</div><div class="item-owned">SE√áƒ∞Lƒ∞</div>`;
                    div.onclick = () => {
                        if(c.owned) { Data.selected = c.id; Data.save(); this.openShop(); } 
                        else if(Data.money >= c.price) {
                            if(confirm("Al?")) { Data.money -= c.price; c.owned = true; Data.selected = c.id; Data.save(); this.openShop(); }
                        }
                    };
                    grid.appendChild(div);
                });
            }
        };

        // --- OYUN MOTORU (KESƒ∞N √á√ñZ√úML√ú) ---
        const Game = {
            wrapper: document.getElementById('gameWrapper'),
            cvs: document.getElementById('gameCanvas'),
            ctx: document.getElementById('gameCanvas').getContext('2d'),
            scale: 1, state: "STOP",
            score: 0, sessionMoney: 0, speed: 0,
            
            player: { x:50, y:0, w:50, h:80, dy:0, state:"run", icon:"üë©‚Äç‚öïÔ∏è" },
            obstacles: [], rewards: [],

            init: function() {
                Data.load();
                this.resize();
                window.addEventListener('resize', () => this.resize());
                
                // --- KONTROLLER (√ñNEMLƒ∞ KISIM) ---
                
                // 1. KLAVYE (Window seviyesinde dinliyoruz)
                window.addEventListener('keydown', e => {
                    // Oyun oynanƒ±yorsa Space ve Ok tu≈ülarƒ±nƒ±n sayfayƒ± kaydƒ±rmasƒ±nƒ± engelle
                    if(this.state === "PLAY" && ['Space', 'ArrowUp', 'ArrowDown'].includes(e.code)) {
                        e.preventDefault(); 
                    }
                    if(e.repeat) return;
                    this.input(e.code);
                });

                // 2. MOUSE / DOKUNMATƒ∞K
                let tY = 0;
                
                // Mouse Tƒ±klama
                this.wrapper.addEventListener('mousedown', () => this.input('Click'));

                // Mobil Dokunma
                this.wrapper.addEventListener('touchstart', e => { tY = e.touches[0].clientY; }, {passive: false});
                this.wrapper.addEventListener('touchend', e => {
                    let diff = tY - e.changedTouches[0].clientY;
                    if(diff > 50) this.input('SwipeUp');       // Yukarƒ± Kaydƒ±r
                    else if(diff < -50) this.input('SwipeDown'); // A≈üaƒüƒ± Kaydƒ±r
                    else this.input('Click');                  // Dokun
                }, {passive: false});

                this.loop();
            },

            resize: function() {
                this.cvs.width = window.innerWidth;
                this.cvs.height = window.innerHeight;
                this.scale = Math.min(this.cvs.width / 400, this.cvs.height / 600);
                if(this.scale > 1.2) this.scale = 1.2;
            },

            start: function() {
                // Odaƒüƒ± butondan alƒ±p oyun alanƒ±na veriyoruz (Space tu≈üu sorunu i√ßin)
                this.wrapper.focus(); 
                document.activeElement.blur(); 

                UI.showScreen(null);
                this.score = 0; this.sessionMoney = 0; this.speed = 6 * this.scale;
                this.obstacles = []; this.rewards = [];
                
                this.player.icon = Data.getChar();
                this.player.y = 0; 
                this.player.dy = 0; 
                this.player.state = "jump"; 
                
                document.getElementById('dispScore').innerText = 0;
                this.state = "PLAY";
            },

            togglePause: function() {
                if(this.state === "PLAY") { this.state = "PAUSE"; UI.showScreen('screenPause'); }
                else if(this.state === "PAUSE") { this.state = "PLAY"; UI.showScreen(null); }
            },

            input: function(code) {
                if(this.state !== "PLAY") {
                    if(code === 'Escape') this.togglePause();
                    return;
                }

                if(['Space','ArrowUp','SwipeUp','Click'].includes(code)) {
                    if(this.player.state !== "jump") {
                        this.player.dy = -15 * this.scale;
                        this.player.state = "jump";
                    }
                }
                else if(['ArrowDown','SwipeDown'].includes(code)) {
                    this.player.state = "duck";
                    setTimeout(() => { if(this.state==="PLAY" && this.player.state==="duck") this.player.state="run"; }, 600);
                }
                else if(code === 'Escape') this.togglePause();
            },

            update: function() {
                this.speed += 0.002 * this.scale;
                const S = this.scale;
                const groundY = this.cvs.height - (100 * S);

                // Fizik
                let gravity = (this.player.state === "duck" ? 1.5 : 0.7) * S;
                this.player.h = (this.player.state === "duck" ? 50 : 80) * S;

                if(this.player.y + this.player.h < groundY) {
                    this.player.dy += gravity;
                    this.player.y += this.player.dy;
                } else {
                    this.player.dy = 0;
                    this.player.y = groundY - this.player.h;
                    if(this.player.state === "jump") this.player.state = "run";
                }

                // Spawn
                let minGap = 400 * S + (this.speed * 20);
                let lastX = this.obstacles.length > 0 ? this.obstacles[this.obstacles.length-1].x : -999;

                if(this.cvs.width - lastX > minGap) {
                    if(Math.random() < 0.06) {
                        let high = Math.random() > 0.7;
                        let obs = {
                            x: this.cvs.width, w: 50*S, h: 50*S,
                            icon: high ? "ü¶á" : "ü¶†",
                            y: high ? groundY - (110*S) : groundY - (50*S)
                        };
                        this.obstacles.push(obs);

                        if(Math.random() > 0.3) {
                            this.rewards.push({
                                x: this.cvs.width + 100*S,
                                y: groundY - (high ? 60*S : 150*S),
                                w: 40*S, h: 40*S, icon: "üíµ"
                            });
                        }
                    }
                }

                // Hareket & √áarpƒ±≈üma
                for(let i=this.obstacles.length-1; i>=0; i--) {
                    let o = this.obstacles[i]; o.x -= this.speed;
                    let m = 15*S;
                    if(this.player.x < o.x+o.w-m && this.player.x+this.player.w-m > o.x &&
                       this.player.y < o.y+o.h-m && this.player.y+this.player.h > o.y+m) {
                        this.gameOver(); return;
                    }
                    if(o.x+o.w < 0) {
                        this.obstacles.splice(i,1); this.score++;
                        document.getElementById('dispScore').innerText = this.score;
                        if(this.score%100===0) {
                            document.getElementById('celebration').classList.remove('hidden');
                            setTimeout(()=>document.getElementById('celebration').classList.add('hidden'), 2000);
                        }
                    }
                }

                for(let i=this.rewards.length-1; i>=0; i--) {
                    let r = this.rewards[i]; r.x -= this.speed;
                    if(this.player.x < r.x+r.w && this.player.x+this.player.w > r.x &&
                       this.player.y < r.y+r.h && this.player.y+this.player.h > r.y) {
                        this.sessionMoney += 5;
                        document.getElementById('dispMoney').innerText = Data.money + this.sessionMoney;
                        this.rewards.splice(i,1);
                    } else if(r.x+r.w < 0) this.rewards.splice(i,1);
                }
            },

            draw: function() {
                const S = this.scale;
                const groundY = this.cvs.height - (100 * S);
                this.ctx.clearRect(0, 0, this.cvs.width, this.cvs.height);

                // Zemin (Canvas ile)
                this.ctx.fillStyle = '#795548'; 
                this.ctx.fillRect(0, groundY, this.cvs.width, 100*S);
                this.ctx.fillStyle = '#4CAF50'; 
                this.ctx.fillRect(0, groundY, this.cvs.width, 20*S);

                // Oyuncu
                this.ctx.font = this.player.state === "duck" ? `${50*S}px Arial` : `${80*S}px Arial`;
                this.ctx.lineWidth = 4 * S;
                this.ctx.strokeStyle = "white"; 
                this.ctx.lineJoin = "round";
                let py = this.player.y + this.player.h;
                this.ctx.strokeText(this.player.icon, this.player.x, py);
                this.ctx.fillStyle = "black";
                this.ctx.fillText(this.player.icon, this.player.x, py);

                // Objeler
                this.ctx.font = `${50*S}px Arial`;
                this.obstacles.forEach(o => {
                    this.ctx.strokeText(o.icon, o.x, o.y + 45*S);
                    this.ctx.fillText(o.icon, o.x, o.y + 45*S);
                });

                this.ctx.font = `${40*S}px Arial`; this.ctx.strokeStyle = "green";
                this.rewards.forEach(r => {
                    this.ctx.strokeText(r.icon, r.x, r.y + 35*S);
                    this.ctx.fillText(r.icon, r.x, r.y + 35*S);
                });
            },

            gameOver: function() {
                this.state = "GAMEOVER";
                Data.money += this.sessionMoney; Data.save();
                sendScore(this.score);
                document.getElementById('endScore').innerText = this.score;
                document.getElementById('endMoney').innerText = this.sessionMoney;
                UI.showScreen('screenOver');
            },

            loop: function() {
                if(this.state === "PLAY") this.update();
                this.draw();
                requestAnimationFrame(() => this.loop());
            }
        };

        Game.init();

    </script>
</body>
</html>