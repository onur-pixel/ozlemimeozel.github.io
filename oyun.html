<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dr. √ñzlem: Hƒ±zlƒ± ve √ñfkeli üõçÔ∏è</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Poppins:wght@400;900&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: #222;
            overflow: hidden;
            touch-action: none;
            font-family: 'Poppins', sans-serif;
        }

        #gameCanvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* --- ARAY√úZ KATMANI --- */
        .ui-layer {
            position: absolute; top: 15px; left: 15px; right: 15px; pointer-events: none;
            display: flex; justify-content: space-between; z-index: 20;
        }

        .hud-group { display: flex; gap: 8px; }

        .hud-box {
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 18px; border-radius: 50px;
            border-bottom: 4px solid #bbb;
            color: #333; font-size: 1rem; font-weight: 800;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            display: flex; align-items: center; gap: 6px;
            pointer-events: auto;
        }

        /* --- Lƒ∞DER TABLOSU (SAƒû ORTA - ESKƒ∞ YERƒ∞NDE) --- */
        #leaderboard {
            position: absolute; top: 50%; right: 15px; transform: translateY(-50%);
            background: #fff; border-radius: 15px; padding: 12px; width: 170px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3); z-index: 50; border: 4px solid #4facfe;
        }
        #leaderboard h3 { 
            text-align: center; margin-bottom: 8px; color: #0072ff; 
            font-family: 'Fredoka One', cursive; font-size: 0.9rem; letter-spacing: 1px;
            border-bottom: 2px dashed #ccc; padding-bottom: 5px;
        }
        .score-item { display: flex; justify-content: space-between; padding: 5px; font-weight: bold; border-radius: 6px; margin-bottom: 4px; font-size: 0.8rem; }
        .score-item:nth-child(2) { background: #FFD700; } /* 1. Altƒ±n */
        .score-item:nth-child(3) { background: #C0C0C0; } /* 2. G√ºm√º≈ü */
        .score-item:nth-child(4) { background: #CD7F32; } /* 3. Bronz */

        /* --- MAƒûAZA EKRANI --- */
        #shopScreen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.98); z-index: 150;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        
        .shop-header {
            display: flex; justify-content: space-between; width: 90%; max-width: 400px;
            align-items: center; margin-bottom: 15px;
        }

        .shop-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;
            max-height: 55vh; overflow-y: auto; padding: 10px; width: 95%; max-width: 450px;
        }

        .shop-item {
            background: #fff; border: 3px solid #eee; border-radius: 15px;
            padding: 5px; text-align: center; cursor: pointer; transition: 0.1s;
            position: relative; height: 110px; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            box-shadow: 0 4px 0 #ddd;
        }
        .shop-item:active { transform: translateY(3px); box-shadow: 0 2px 0 #ddd; }
        .shop-item.selected { border-color: #00f260; background: #e8f5e9; border-width: 4px; transform: scale(1.03); }
        .shop-item.locked { opacity: 0.6; filter: grayscale(1); }
        
        .shop-emoji { font-size: 2.2rem; margin-bottom: 5px; }
        .shop-price { font-size: 0.8rem; font-weight: bold; color: #fff; background: #555; padding: 2px 8px; border-radius: 10px; }
        .shop-owned { font-size: 0.7rem; color: #27ae60; font-weight: 900; display: none; text-transform: uppercase; }
        
        .shop-item.owned .shop-price { display: none; }
        .shop-item.owned .shop-owned { display: block; }

        /* --- MEN√úLER --- */
        .screen {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; background: #ffffff; padding: 30px;
            border-radius: 30px; border: 5px solid #4facfe;
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
            width: 90%; max-width: 400px; z-index: 100;
        }
        .hidden { display: none !important; }

        h1 { font-family: 'Fredoka One', cursive; font-size: 1.8rem; margin-bottom: 10px; color: #333; }
        
        input {
            width: 100%; padding: 12px; font-size: 1.1rem; border: 2px solid #ddd;
            border-radius: 50px; margin-bottom: 15px; font-family: 'Poppins', sans-serif;
            text-align: center; font-weight: bold; outline: none;
        }
        input:focus { border-color: #4facfe; }

        .btn-primary {
            background: linear-gradient(45deg, #00c6ff, #0072ff);
            color: #fff; border: none; padding: 12px 30px; font-size: 1rem; font-weight: 900;
            border-radius: 50px; cursor: pointer; box-shadow: 0 5px 0 #0056b3;
            transition: transform 0.1s; text-transform: uppercase; width: 100%; margin-bottom: 10px;
        }
        .btn-primary:active { transform: translateY(3px); box-shadow: 0 2px 0 #0056b3; }
        
        .btn-shop { background: linear-gradient(45deg, #ff9966, #ff5e62); box-shadow: 0 5px 0 #c0392b; }
        .btn-shop:active { box-shadow: 0 2px 0 #c0392b; transform: translateY(3px); }
        
        .btn-close { background: #555; width: auto; padding: 8px 30px; margin-top: 10px; box-shadow: 0 5px 0 #333; }

        /* Pause Butonu */
        #pauseBtn {
            cursor: pointer; width: 45px; height: 45px; justify-content: center;
            background: #fff; border: 3px solid #4facfe; font-size: 1.4rem;
            display: flex; align-items: center; border-radius: 50%;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
        }
        #pauseBtn:active { transform: translateY(2px); box-shadow: 0 2px 0 rgba(0,0,0,0.2); }

        #celebrationMsg {
            position: absolute; top: 20%; width: 100%; text-align: center; font-size: 3rem;
            font-family: 'Fredoka One', cursive; color: #FFD700; -webkit-text-stroke: 2px #fff;
            text-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 50; pointer-events: none;
            animation: popIn 0.5s;
        }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

        .home-btn {
            position: absolute; top: 70px; left: 15px; background: #fff; padding: 8px 15px;
            border-radius: 10px; text-decoration: none; color: #333; font-weight: 800;
            border: 2px solid #ddd; z-index: 60; font-size: 0.8rem;
        }

    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <div class="ui-layer">
        <div class="hud-group">
            <div class="hud-box">üë§ <span id="playerNameDisplay">Misafir</span></div>
            <div class="hud-box" style="color:#0072ff">‚ö° <span id="scoreVal">0</span></div>
            <div class="hud-box" style="color:#27ae60">üíµ <span id="moneyVal">0</span></div>
        </div>
        <div id="pauseBtn" onclick="togglePause()">‚è∏Ô∏è</div>
    </div>

    <div id="leaderboard">
        <h3>üèÜ TOP 3</h3>
        <div id="scoreList">Y√ºkleniyor...</div>
    </div>

    <div id="celebrationMsg" class="hidden">100 PUAN! üéâ</div>
    <a href="index.html" class="home-btn">üè† √áƒ±kƒ±≈ü</a>

    <div id="shopScreen" class="hidden">
        <div class="shop-header">
            <h1 style="font-size:1.5rem; margin:0;">KARAKTERLER</h1>
            <div class="hud-box" style="color:#27ae60">üíµ <span id="shopBalance">0</span></div>
        </div>
        <div class="shop-grid" id="shopGrid"></div>
        <button class="btn-primary btn-close" onclick="closeShop()">KAPAT</button>
    </div>

    <div id="nameScreen" class="screen">
        <h1>Dr. √ñzlem Ko≈üuyor</h1>
        <p style="color:#666; margin-bottom:15px; font-size:0.9rem;">Sƒ±ralama i√ßin adƒ±nƒ± yaz:</p>
        <input type="text" id="nameInput" placeholder="ƒ∞sminiz..." maxlength="12">
        <button class="btn-primary" onclick="submitName()">KAYDET VE Gƒ∞R</button>
    </div>

    <div id="startScreen" class="screen hidden">
        <h1>HAZIRLAN!</h1>
        <p style="color:#555; margin-bottom:20px; font-size:0.9rem;">
            üëÜ <b>Zƒ±pla</b> | üëá <b>Eƒüil</b><br>
            üíµ Para topla, karakter al!
        </p>
        <button class="btn-primary" onclick="startGame()">KO≈ûMAYA BA≈ûLA üèÉ‚Äç‚ôÄÔ∏è</button>
        <button class="btn-primary btn-shop" onclick="openShop()">üè™ MAƒûAZA</button>
    </div>

    <div id="pauseScreen" class="screen hidden">
        <h1>DURAKLATILDI</h1>
        <button class="btn-primary" onclick="togglePause()">DEVAM ET ‚ñ∂Ô∏è</button>
        <button class="btn-primary" style="background:#ff4757; box-shadow:0 5px 0 #c0392b;" onclick="location.reload()">√áIKI≈û</button>
    </div>

    <div id="gameOverScreen" class="screen hidden">
        <h1 style="color:#e74c3c;">YANDIN!</h1>
        <div style="display:flex; justify-content:space-around; width:100%; margin-bottom:15px;">
            <div>
                <p style="font-size:0.8rem; color:#555;">KAZAN√á</p>
                <p style="font-size:1.2rem; font-weight:bold; color:#27ae60;">üíµ <span id="collectedMoney">0</span></p>
            </div>
            <div>
                <p style="font-size:0.8rem; color:#555;">SKOR</p>
                <p style="font-size:1.2rem; font-weight:bold; color:#0072ff;">‚ö° <span id="finalScore">0</span></p>
            </div>
        </div>
        <button class="btn-primary" onclick="backToMenu()">MEN√úYE D√ñN üè†</button>
    </div>

    <script>
        // --- VERƒ∞ Y√ñNETƒ∞Mƒ∞ ---
        const GameData = {
            money: 0,
            characters: [
                { id: 0, emoji: "üë©‚Äç‚öïÔ∏è", price: 0, owned: true },
                { id: 1, emoji: "üëÆ‚Äç‚ôÄÔ∏è", price: 50, owned: false },
                { id: 2, emoji: "üïµÔ∏è‚Äç‚ôÄÔ∏è", price: 150, owned: false },
                { id: 3, emoji: "üßü‚Äç‚ôÄÔ∏è", price: 300, owned: false },
                { id: 4, emoji: "üßõ‚Äç‚ôÄÔ∏è", price: 500, owned: false },
                { id: 5, emoji: "ü§ñ", price: 1000, owned: false }
            ],
            selectedCharId: 0,
            load: function() {
                const saved = localStorage.getItem('dr_ozlem_shop_v6');
                if(saved) {
                    const data = JSON.parse(saved);
                    this.money = data.money || 0;
                    if(data.characters) this.characters = data.characters;
                    this.selectedCharId = data.selectedCharId || 0;
                }
            },
            save: function() { localStorage.setItem('dr_ozlem_shop_v6', JSON.stringify(this)); },
            getSelectedEmoji: function() { return this.characters.find(c => c.id === this.selectedCharId).emoji; }
        };
        GameData.load();

        // --- FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBHejjQe2dHnwDYES3Qd30HKO94-_D5lVA",
            authDomain: "ask-oyunu-5d368.firebaseapp.com",
            databaseURL: "https://ask-oyunu-5d368-default-rtdb.firebaseio.com",
            projectId: "ask-oyunu-5d368",
            storageBucket: "ask-oyunu-5d368.firebasestorage.app",
            messagingSenderId: "550862375128",
            appId: "1:550862375128:web:fb49cef5e3c5440d996fad",
            measurementId: "G-T1GCW04QD0"
        };

        try {
            firebase.initializeApp(firebaseConfig);
            const db = firebase.database();
            const scoresRef = db.ref('runner_scores_money'); 
            scoresRef.orderByChild('score').limitToLast(3).on('value', (snapshot) => {
                const list = document.getElementById('scoreList');
                list.innerHTML = "";
                let scores = [];
                snapshot.forEach((child) => { scores.push(child.val()); });
                scores.reverse().forEach((s, index) => {
                    list.innerHTML += `<div class="score-item"><span>${index+1}.${s.name}</span><span>${s.score}</span></div>`;
                });
            });
        } catch(e) { console.error(e); }

        let playerName = "Misafir";
        function submitName() {
            const input = document.getElementById('nameInput').value.trim();
            if(input) {
                playerName = input;
                document.getElementById('playerNameDisplay').innerText = playerName;
                document.getElementById('nameScreen').classList.add('hidden');
                document.getElementById('startScreen').classList.remove('hidden');
                updateMoneyUI();
            } else alert("ƒ∞sim gerekli!");
        }

        function saveScore(score) {
            if(typeof firebase !== 'undefined' && score > 0) {
                firebase.database().ref('runner_scores_money').push({ name: playerName, score: score, date: Date.now() });
            }
        }

        function updateMoneyUI() {
            document.getElementById('moneyVal').innerText = GameData.money;
            document.getElementById('shopBalance').innerText = GameData.money;
        }

        // --- MAƒûAZA ---
        function openShop() {
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('shopScreen').classList.remove('hidden');
            renderShop();
        }
        function closeShop() {
            document.getElementById('shopScreen').classList.add('hidden');
            document.getElementById('startScreen').classList.remove('hidden');
        }
        function renderShop() {
            const grid = document.getElementById('shopGrid');
            grid.innerHTML = "";
            document.getElementById('shopBalance').innerText = GameData.money;
            GameData.characters.forEach(char => {
                const item = document.createElement('div');
                item.className = `shop-item ${char.owned ? 'owned' : ''} ${GameData.selectedCharId === char.id ? 'selected' : ''}`;
                if(!char.owned && GameData.money < char.price) item.classList.add('locked');
                item.innerHTML = `
                    <div class="shop-emoji">${char.emoji}</div>
                    <div class="shop-price">üíµ ${char.price}</div>
                    <div class="shop-owned">${GameData.selectedCharId === char.id ? 'SE√áƒ∞Lƒ∞' : 'SAHƒ∞PSƒ∞N'}</div>
                `;
                item.onclick = () => buyOrSelect(char.id);
                grid.appendChild(item);
            });
        }
        function buyOrSelect(id) {
            const char = GameData.characters.find(c => c.id === id);
            if (char.owned) {
                GameData.selectedCharId = id; GameData.save(); renderShop();
            } else {
                if (GameData.money >= char.price) {
                    if(confirm(`${char.price} Para kar≈üƒ±lƒ±ƒüƒ± satƒ±n al?`)) {
                        GameData.money -= char.price; char.owned = true;
                        GameData.selectedCharId = id; GameData.save(); renderShop(); updateMoneyUI();
                    }
                }
            }
        }

        // --- OYUN MOTORU (Canvas + Fizik Optimizasyonu) ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        let S = 1; 
        let isPlaying = false, isPaused = false;
        let score = 0, sessionMoney = 0;
        let gameSpeed = 0, frames = 0;
        let celebrated100 = false;

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            S = canvas.height / 600; 
            if(canvas.width < 500) S *= 0.85;
        }
        window.addEventListener('resize', resize);
        resize();

        // Arka Plan Objeleri (Optimize)
        const bgLayers = {
            clouds: { items: [], speed: 0.2 },
            mountains: { items: [], speed: 0.5 }
        };

        function initBG() {
            bgLayers.clouds.items = []; bgLayers.mountains.items = [];
            for(let i=0; i<6; i++) {
                bgLayers.clouds.items.push({ x: Math.random()*canvas.width, y: Math.random()*200*S, type: "‚òÅÔ∏è" });
                bgLayers.mountains.items.push({ x: i*300*S, y: canvas.height-160*S, type: "üèîÔ∏è" });
            }
        }

        const ground = {
            get h() { return 100 * S; },
            get y() { return canvas.height - this.h; },
            draw: function() {
                // Zemin √áizimi (Canvas) - Eski sevdiƒüin stil
                ctx.fillStyle = '#795548'; ctx.fillRect(0, this.y, canvas.width, this.h);
                ctx.fillStyle = '#4CAF50'; ctx.fillRect(0, this.y, canvas.width, 25*S);
                // √áizgiler
                ctx.fillStyle = 'rgba(0,0,0,0.1)';
                let gap = 200 * S;
                for(let i=0; i<canvas.width + gap; i+=gap) {
                    let off = (i - (frames*gameSpeed)) % (canvas.width + gap);
                    if(off<0) off += canvas.width + gap;
                    ctx.fillRect(off, this.y+25*S, 40*S, 15*S);
                }
            }
        };

        const player = {
            x: 50 * S, y: 0, w: 60 * S, h: 80 * S,
            dy: 0, gravity: 0.7 * S, jumpPower: 16 * S, // Fizik deƒüerleri artƒ±rƒ±ldƒ± (Keskin zƒ±plama)
            grounded: false, isDucking: false, emoji: "üë©‚Äç‚öïÔ∏è",
            
            draw: function() {
                let bounce = this.grounded ? Math.sin(frames*0.2)*5*S : 0;
                let fs = this.isDucking ? 50*S : 80*S;
                ctx.font = `${fs}px Arial`;
                
                // Kont√ºr (Netlik)
                ctx.lineWidth = 5 * S; ctx.strokeStyle = "white"; ctx.lineJoin = "round";
                ctx.strokeText(this.emoji, this.x, this.y + this.h + bounce);
                ctx.fillStyle = "black"; 
                ctx.fillText(this.emoji, this.x, this.y + this.h + bounce);
            },
            update: function() {
                if(this.isDucking) { this.h=50*S; this.gravity=1.3*S; } // Eƒüilince hƒ±zlƒ± in
                else { this.h=80*S; this.gravity=0.7*S; }

                if(!this.grounded) { this.dy+=this.gravity; this.y+=this.dy; } else { this.dy=0; }
                if(this.y > ground.y - this.h) { this.y = ground.y - this.h; this.grounded = true; }
            },
            jump: function() {
                if(this.grounded && !this.isDucking) {
                    this.dy = -this.jumpPower; this.grounded = false;
                }
            }
        };

        let obstacles = []; let rewards = [];

        function startGame() {
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('gameOverScreen').classList.add('hidden');
            document.getElementById('celebrationMsg').classList.add('hidden');
            
            score = 0; sessionMoney = 0; frames = 0; gameSpeed = 7 * S;
            obstacles = []; rewards = []; celebrated100 = false;
            
            updateInGameUI();
            initBG();
            player.emoji = GameData.getSelectedEmoji();
            player.y = ground.y - player.h; // Yerde ba≈ülat
            
            isPlaying = true; isPaused = false;
            loop();
        }

        function togglePause() {
            if(!isPlaying) return;
            isPaused = !isPaused;
            if(isPaused) document.getElementById('pauseScreen').classList.remove('hidden');
            else { document.getElementById('pauseScreen').classList.add('hidden'); loop(); }
        }

        function updateInGameUI() {
            document.getElementById('scoreVal').innerText = score;
            document.getElementById('moneyVal').innerText = GameData.money + sessionMoney;
        }

        function spawn() {
            let minGap = 400 * S + (gameSpeed * 20);
            let lastX = obstacles.length > 0 ? obstacles[obstacles.length-1].x : -999;
            if(canvas.width - lastX > minGap) {
                if(Math.random() < 0.06) {
                    let type = Math.random();
                    let obs = { x: canvas.width, w: 50*S, h: 50*S, emoji: "ü¶†", isHigh: false };
                    if(type > 0.7) { obs.emoji = "ü¶á"; obs.isHigh = true; obs.y = ground.y - 110*S; }
                    else { obs.y = ground.y - 50*S; }
                    obstacles.push(obs);

                    if(Math.random() > 0.3) {
                        rewards.push({
                            x: canvas.width + 100*S + Math.random()*200*S,
                            y: ground.y - (obs.isHigh ? 60*S : 150*S),
                            w: 40*S, h: 40*S, emoji: "üíµ"
                        });
                    }
                }
            }
        }

        function update() {
            if(!isPlaying || isPaused) return;
            frames++;
            if(frames%600===0) gameSpeed += 0.2*S;

            player.update();
            spawn();

            for(let i=obstacles.length-1; i>=0; i--) {
                let o = obstacles[i];
                o.x -= gameSpeed;
                let margin = 10*S;
                if(player.x < o.x + o.w - margin && player.x + player.w - margin > o.x &&
                   player.y < o.y + o.h - margin && player.y + player.h > o.y + margin) {
                    gameOver();
                }
                if(o.x + o.w < 0) {
                    obstacles.splice(i,1); score++; updateInGameUI();
                    if(score>=100 && !celebrated100) { celebrated100=true; document.getElementById('celebrationMsg').classList.remove('hidden'); setTimeout(()=>document.getElementById('celebrationMsg').classList.add('hidden'),2000); }
                }
            }

            for(let i=rewards.length-1; i>=0; i--) {
                let r = rewards[i];
                r.x -= gameSpeed;
                if(player.x < r.x + r.w && player.x + player.w > r.x &&
                   player.y < r.y + r.h && player.y + player.h > r.y) {
                    sessionMoney += 5; updateInGameUI(); rewards.splice(i,1);
                } else if(r.x + r.w < 0) rewards.splice(i,1);
            }
        }

        function gameOver() {
            isPlaying = false;
            GameData.money += sessionMoney;
            GameData.save();
            saveScore(score);
            document.getElementById('collectedMoney').innerText = sessionMoney;
            document.getElementById('finalScore').innerText = score;
            document.getElementById('gameOverScreen').classList.remove('hidden');
        }

        function backToMenu() {
            document.getElementById('gameOverScreen').classList.add('hidden');
            document.getElementById('startScreen').classList.remove('hidden');
            updateMoneyUI();
        }

        function draw() {
            // G√∂ky√ºz√º √áizimi (Canvas - Eski G√ºzel Hali)
            let grad = ctx.createLinearGradient(0,0,0,canvas.height);
            grad.addColorStop(0, '#87CEEB'); grad.addColorStop(1, '#E0F7FA');
            ctx.fillStyle = grad; ctx.fillRect(0,0,canvas.width,canvas.height);

            // Arka Plan
            ctx.font = `${120*S}px Arial`;
            bgLayers.mountains.items.forEach(m => {
                if(!isPaused) m.x -= bgLayers.mountains.speed * S;
                if(m.x < -300*S) m.x = canvas.width;
                ctx.globalAlpha = 1.0; ctx.fillText(m.type, m.x, ground.y);
            });
            ctx.font = `${80*S}px Arial`;
            bgLayers.clouds.items.forEach(c => {
                if(!isPaused) c.x -= bgLayers.clouds.speed * S;
                if(c.x < -150*S) c.x = canvas.width;
                ctx.globalAlpha = 0.9; ctx.fillStyle = "#fff"; ctx.fillText(c.type, c.x, c.y);
            });
            ctx.globalAlpha = 1.0;

            ground.draw();
            player.draw();

            for(let o of obstacles) {
                ctx.font = `${50*S}px Arial`;
                ctx.lineWidth = 3*S; ctx.strokeStyle = "white"; 
                ctx.strokeText(o.emoji, o.x, o.y+45*S);
                ctx.fillStyle="black"; ctx.fillText(o.emoji, o.x, o.y+45*S);
            }
            for(let r of rewards) {
                ctx.font = `${40*S}px Arial`;
                ctx.lineWidth = 3*S; ctx.strokeStyle = "green";
                ctx.strokeText(r.emoji, r.x, r.y+35*S);
                ctx.fillText(r.emoji, r.x, r.y+35*S);
            }
        }

        function loop() {
            if(isPlaying) {
                if(!isPaused) update();
                draw();
                if(!isPaused) requestAnimationFrame(loop);
            }
        }

        // KONTROLLER
        function jumpAction() { if(isPlaying && !isPaused) player.jump(); }
        function duckAction(isActive) { if(isPlaying && !isPaused) player.isDucking = isActive; }

        window.addEventListener('keydown', e=>{
            if (e.repeat) return; // Tu≈ü basƒ±lƒ± tutulursa tekrar tetiklemeyi engelle (Performans)
            if(e.code==='Space'||e.code==='ArrowUp') jumpAction();
            if(e.code==='ArrowDown') duckAction(true);
            if(e.code==='Escape') togglePause();
        });
        window.addEventListener('keyup', e=>{ if(e.code==='ArrowDown') duckAction(false); });

        let tY = 0;
        window.addEventListener('touchstart', e=>{ tY=e.touches[0].clientY; }, {passive:false});
        window.addEventListener('touchend', e=>{
            let diff = tY - e.changedTouches[0].clientY;
            if(diff > 50) jumpAction();
            else if(diff < -50) { player.isDucking = true; setTimeout(()=>player.isDucking=false, 600); }
            else jumpAction();
        }, {passive:false});

    </script>
</body>
</html>