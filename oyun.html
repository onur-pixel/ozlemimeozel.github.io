<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dr. √ñzlem: B√ºy√ºk Ko≈üu (HIZLI)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto:wght@400;700&display=swap');

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #2563eb;
            font-family: 'Roboto', sans-serif;
            touch-action: none; /* Mobilde kaydƒ±rma ve zoom'u engelle */
            user-select: none;
            -webkit-user-select: none;
        }

        #gameCanvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        .pixel-font {
            font-family: 'Press Start 2P', cursive;
        }

        /* UI Katmanlarƒ± */
        .ui-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20;
            transition: opacity 0.3s;
        }

        /* Yarƒ± saydam arka planlar */
        .bg-overlay {
            background: rgba(15, 23, 42, 0.95);
        }

        /* Maƒüaza Grid */
        .shop-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
        }

        .shop-item {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #3b82f6;
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .shop-item.locked {
            opacity: 0.6;
            filter: grayscale(1);
        }

        .shop-item.selected {
            border-color: #fbbf24;
            background: rgba(251, 191, 36, 0.2);
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.4);
        }

        .shop-item:active {
            transform: scale(0.95);
        }

        /* Lider Tablosu */
        #leaderboard {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.85);
            border: 2px solid #fbbf24;
            border-radius: 8px;
            padding: 10px;
            color: white;
            z-index: 10;
            pointer-events: none;
            font-size: 10px;
            min-width: 160px;
            max-width: 200px;
        }

        /* Hata mesajƒ± stili */
        .error-text {
            color: #ef4444;
            font-size: 9px;
            margin-top: 5px;
            text-align: center;
        }
        
        button:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body>

    <!-- Oyun Alanƒ± -->
    <canvas id="gameCanvas"></canvas>

    <!-- HUD (Oyun ƒ∞√ßi G√∂stergeler) -->
    <div id="hud" class="absolute top-0 left-0 w-full p-4 pointer-events-none flex justify-between z-10 hidden">
        <div class="text-white pixel-font text-xl drop-shadow-md">
            SKOR: <span id="score-val" class="text-yellow-400">0</span>
        </div>
        <div class="text-white pixel-font text-sm drop-shadow-md flex items-center gap-2">
            üíä <span id="coins-val">0</span>
        </div>
    </div>

    <!-- Global Lider Tablosu -->
    <div id="leaderboard">
        <div class="text-yellow-400 text-center mb-2 font-bold border-b border-gray-600 pb-1">üèÜ GLOBAL TOP 3</div>
        <div id="leaderboard-list" class="space-y-1">
            <div class="text-gray-400 text-center animate-pulse">Y√ºkleniyor...</div>
        </div>
        <div id="leaderboard-error" class="error-text hidden"></div>
    </div>

    <!-- Ba≈ülangƒ±√ß Ekranƒ± -->
    <div id="start-screen" class="ui-screen bg-overlay">
        <div class="text-6xl mb-4 animate-bounce" id="current-char-icon">üë©‚Äç‚öïÔ∏è</div>
        <h1 class="pixel-font text-3xl md:text-5xl text-white mb-2 text-center text-shadow-lg">
            DR. √ñZLEM<br><span class="text-yellow-400 text-2xl md:text-4xl">HIZLI KO≈ûU</span>
        </h1>
        
        <div class="bg-white/10 backdrop-blur-md p-6 rounded-xl border border-white/20 w-80 text-center mt-4">
            <input type="text" id="player-name" placeholder="ADINIZ (MAX 10)" maxlength="10" 
                class="w-full bg-slate-800 text-white border-2 border-blue-500 rounded px-4 py-3 mb-4 text-center pixel-font focus:outline-none focus:border-yellow-400 uppercase">
            
            <button id="start-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 rounded-lg pixel-font shadow-lg border-b-4 border-green-700 mb-3 transition-transform">
                KO≈ûUYA BA≈ûLA
            </button>
            
            <button id="shop-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-lg pixel-font shadow-lg border-b-4 border-blue-700 text-sm">
                üè• ECZANE (MAƒûAZA)
            </button>
        </div>
        <div class="text-gray-400 mt-4 text-xs">Masa√ºst√º: Space/Tƒ±kla ‚Ä¢ Mobil: Dokun</div>
    </div>

    <!-- Maƒüaza Ekranƒ± -->
    <div id="shop-screen" class="ui-screen bg-overlay hidden">
        <h2 class="pixel-font text-2xl text-yellow-400 mb-6">ECZANE</h2>
        <div class="text-white mb-4">BAKƒ∞YENƒ∞Z: <span id="shop-coins" class="text-green-400 font-bold">0</span> üíä</div>
        
        <div class="shop-grid bg-slate-800 p-4 rounded-xl border border-slate-600 w-11/12 max-w-md">
            <!-- Market √ñƒüeleri JS ile Doldurulacak -->
        </div>

        <button id="close-shop-btn" class="mt-6 bg-red-500 hover:bg-red-600 text-white py-3 px-8 rounded-lg pixel-font border-b-4 border-red-700">
            KAPAT
        </button>
    </div>

    <!-- Oyun Bitti Ekranƒ± -->
    <div id="game-over-screen" class="ui-screen bg-overlay hidden">
        <h1 class="pixel-font text-red-500 text-4xl mb-4 drop-shadow-lg">YANDIN!</h1>
        <div class="text-white text-xl mb-2">TOPLANAN SKOR</div>
        <div id="final-score" class="pixel-font text-yellow-400 text-5xl mb-8">0</div>
        
        <div class="flex gap-4">
            <button id="restart-btn" class="bg-green-500 hover:bg-green-600 text-white py-4 px-8 rounded-lg pixel-font border-b-4 border-green-700 shadow-xl">
                TEKRAR
            </button>
            <button id="menu-btn" class="bg-gray-500 hover:bg-gray-600 text-white py-4 px-6 rounded-lg pixel-font border-b-4 border-gray-700 shadow-xl">
                MEN√ú
            </button>
        </div>
    </div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE AYARLARI ---
        const firebaseConfig = JSON.parse(new URLSearchParams(window.location.search).get('__firebase_config')) || JSON.parse(__firebase_config);
        const appId = new URLSearchParams(window.location.search).get('__app_id') || (typeof __app_id !== 'undefined' ? __app_id : 'default-app');
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;

        const initAuth = async () => {
             if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                try {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } catch(e) { await signInAnonymously(auth); }
            } else {
                await signInAnonymously(auth);
            }
        };
        initAuth();

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                listenLeaderboard();
            } else {
                document.getElementById('leaderboard-list').innerHTML = '<div class="text-red-400 text-xs">Giri≈ü Yapƒ±lamadƒ±</div>';
            }
        });

        function listenLeaderboard() {
            const collectionPath = collection(db, 'artifacts', appId, 'public', 'data', 'dr_ozlem_global_scores');
            const q = query(collectionPath, orderBy('score', 'desc'), limit(3));
            
            onSnapshot(q, (snapshot) => {
                const listEl = document.getElementById('leaderboard-list');
                const errorEl = document.getElementById('leaderboard-error');
                
                listEl.innerHTML = '';
                errorEl.classList.add('hidden');
                
                if (snapshot.empty) {
                    listEl.innerHTML = '<div class="text-center text-gray-500 text-xs">Hen√ºz skor yok.<br>ƒ∞lk sen ol!</div>';
                    return;
                }

                let rank = 1;
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const row = document.createElement('div');
                    row.className = 'flex justify-between text-xs border-b border-gray-700 pb-1 mb-1 items-center';
                    
                    let medal = rank === 1 ? 'ü•á' : (rank === 2 ? 'ü•à' : 'ü•â');
                    let name = (data.name || "Anonim").substring(0, 8); 
                    
                    row.innerHTML = `
                        <div class="flex items-center gap-1">
                            <span>${medal}</span>
                            <span class="text-white font-mono">${name}</span>
                        </div>
                        <span class="text-green-400 font-bold">${Math.floor(data.score)}</span>
                    `;
                    listEl.appendChild(row);
                    rank++;
                });
            }, (error) => {
                console.error("Leaderboard hatasƒ±:", error);
                const listEl = document.getElementById('leaderboard-list');
                const errorEl = document.getElementById('leaderboard-error');
                listEl.innerHTML = '';
                errorEl.innerText = "Baƒülantƒ± Hatasƒ±!";
                errorEl.classList.remove('hidden');
            });
        }

        window.saveScoreToFirebase = async function(score) {
            if (!currentUser || score < 5) return; 
            const playerName = document.getElementById('player-name').value.trim() || "Dr. Anonim";
            
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'dr_ozlem_global_scores'), {
                    name: playerName,
                    score: Math.floor(score),
                    userId: currentUser.uid,
                    timestamp: serverTimestamp()
                });
            } catch (e) { 
                console.error("Skor kaydedilemedi", e); 
            }
        };
    </script>

    <!-- Oyun Mantƒ±ƒüƒ± -->
    <script>
        // --- OYUN DEƒûƒ∞≈ûKENLERƒ∞ ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // UI Elementleri
        const startScreen = document.getElementById('start-screen');
        const gameOverScreen = document.getElementById('game-over-screen');
        const shopScreen = document.getElementById('shop-screen');
        const hud = document.getElementById('hud');
        const scoreVal = document.getElementById('score-val');
        const coinsVal = document.getElementById('coins-val');
        const finalScoreVal = document.getElementById('final-score');
        const shopCoinsVal = document.getElementById('shop-coins');
        const currentCharIcon = document.getElementById('current-char-icon');

        // Oyun Durumu
        let gameRunning = false;
        let score = 0;
        let coins = parseInt(localStorage.getItem('dr_ozlem_coins')) || 0;
        
        // --- HIZ AYARLARI (TURBO MOD) ---
        // Base Speed 300'den 650'ye √ßƒ±karƒ±ldƒ±
        let baseSpeed = 650; 
        let currentSpeed = baseSpeed;
        
        // Gravity 1500'den 3000'e √ßƒ±karƒ±ldƒ± (Daha hƒ±zlƒ± d√º≈ü√º≈ü)
        let gravity = 3000; 
        
        let lastTime = 0;
        
        let unlockedSkins = JSON.parse(localStorage.getItem('dr_ozlem_skins')) || ['default'];
        let currentSkinId = localStorage.getItem('dr_ozlem_current_skin') || 'default';

        const SKINS = {
            'default': { id: 'default', name: 'Dr. √ñzlem', icon: 'üë©‚Äç‚öïÔ∏è', cost: 0, desc: 'Standart √úniforma' },
            'surgeon': { id: 'surgeon', name: 'Cerrah', icon: 'üò∑', cost: 200, desc: 'Ameliyathane Hazƒ±r' },
            'scientist': { id: 'scientist', name: 'Bilim ƒ∞nsanƒ±', icon: 'üßë‚Äçüî¨', cost: 500, desc: 'Laboratuvar Ustasƒ±' },
            'super': { id: 'super', name: 'S√ºper Dr.', icon: 'ü¶∏‚Äç‚ôÄÔ∏è', cost: 1000, desc: 'Hƒ±zlƒ± ve √ñfkeli' },
            'zombie': { id: 'zombie', name: 'Zombi Dr.', icon: 'üßü‚Äç‚ôÄÔ∏è', cost: 2000, desc: 'Beyin Cerrahƒ±!' }
        };

        // Oyuncu Objesi
        let player = {
            x: 50,
            y: 0,
            w: 50,
            h: 80,
            dy: 0,
            // Jump Power -850'den -1100'e g√º√ßlendirildi (Daha sert zƒ±plama)
            jumpPower: -1100, 
            grounded: false,
            skin: SKINS[currentSkinId].icon
        };

        let obstacles = [];
        let particles = [];
        let houses = []; 
        let groundHeight = 100;
        let bgOffset = 0;
        
        // --- EKRAN AYARLARI ---
        
        function resize() {
            const dpr = Math.min(window.devicePixelRatio || 1, 1.5); 
            canvas.width = window.innerWidth * dpr;
            canvas.height = window.innerHeight * dpr;
            canvas.style.width = window.innerWidth + 'px';
            canvas.style.height = window.innerHeight + 'px';
            ctx.scale(dpr, dpr);
            
            groundHeight = window.innerHeight - 120;
            if(!gameRunning) player.y = groundHeight - player.h;
        }
        window.addEventListener('resize', resize);
        resize();

        // Butonlar
        document.getElementById('start-btn').addEventListener('click', startGame);
        document.getElementById('restart-btn').addEventListener('click', startGame);
        
        const startBtn = document.getElementById('start-btn');
        startBtn.addEventListener('touchstart', (e) => {
            e.preventDefault(); 
            e.stopPropagation();
            startGame();
        }, {passive: false});

        document.getElementById('menu-btn').addEventListener('click', () => {
            gameOverScreen.classList.add('hidden');
            startScreen.classList.remove('hidden');
            hud.classList.add('hidden');
            updateShopUI();
        });

        document.getElementById('shop-btn').addEventListener('click', openShop);
        document.getElementById('close-shop-btn').addEventListener('click', () => {
            shopScreen.classList.add('hidden');
            startScreen.classList.remove('hidden');
            updateCharIcon();
        });

        // Zƒ±plama
        function jump() {
            if (player.grounded && gameRunning) {
                player.dy = player.jumpPower;
                player.grounded = false;
                createParticles(player.x + player.w/2, player.y + player.h, '#fff', 5);
            }
        }

        window.addEventListener('keydown', (e) => {
            if ((e.code === 'Space' || e.code === 'ArrowUp') && gameRunning) jump();
        });

        window.addEventListener('touchstart', (e) => {
            if (gameRunning && !e.target.closest('button')) {
                e.preventDefault(); 
                jump();
            }
        }, { passive: false });

        window.addEventListener('mousedown', (e) => {
            if (gameRunning && !e.target.closest('button')) jump();
        });

        // --- OYUN FONKSƒ∞YONLARI ---

        function generateHouse(x) {
            let h = 80 + Math.random() * 120;
            let w = 60 + Math.random() * 80;
            const colors = ['#334155', '#475569', '#1e293b', '#0f172a'];
            const color = colors[Math.floor(Math.random() * colors.length)];

            let house = {
                x: x,
                y: groundHeight - h,
                w: w,
                h: h,
                color: color,
                windows: []
            };

            let rows = Math.floor(h / 25);
            let cols = Math.floor(w / 20);

            for(let r=0; r<rows; r++) {
                for(let c=0; c<cols; c++) {
                    if(Math.random() > 0.6) {
                        house.windows.push({ x: 10 + c * 20, y: 10 + r * 25 });
                    }
                }
            }
            houses.push(house);
        }

        function initGame() {
            player.y = groundHeight - player.h;
            player.dy = 0;
            player.grounded = true;
            player.skin = SKINS[currentSkinId].icon;
            
            score = 0;
            currentSpeed = baseSpeed; 
            obstacles = [];
            particles = [];
            houses = [];
            lastTime = performance.now();
            
            let hx = 0;
            while(hx < window.innerWidth + 200) {
                generateHouse(hx);
                hx += houses[houses.length-1].w;
            }

            scoreVal.innerText = '0';
            coinsVal.innerText = coins;
        }

        function startGame() {
            const nameInput = document.getElementById('player-name');
            if (!nameInput.value.trim()) {
                nameInput.classList.add('border-red-500', 'animate-pulse');
                setTimeout(() => nameInput.classList.remove('border-red-500', 'animate-pulse'), 500);
                return;
            }

            startScreen.classList.add('hidden');
            gameOverScreen.classList.add('hidden');
            shopScreen.classList.add('hidden');
            hud.classList.remove('hidden');

            resize();
            initGame();
            gameRunning = true;
            requestAnimationFrame(gameLoop);
        }

        function gameOver() {
            gameRunning = false;
            finalScoreVal.innerText = Math.floor(score);
            if (window.saveScoreToFirebase) window.saveScoreToFirebase(score);
            localStorage.setItem('dr_ozlem_coins', coins);
            gameOverScreen.classList.remove('hidden');
            hud.classList.add('hidden');
        }

        function spawnObstacle() {
            let type = Math.random();
            let obs = {
                x: window.innerWidth, 
                y: groundHeight,
                w: 40,
                h: 40,
                char: 'ü¶†', 
                isCoin: false
            };

            if (type < 0.2) { 
                obs.char = 'üíä';
                obs.y = groundHeight - 60 - Math.random() * 80;
                obs.w = 30;
                obs.h = 30;
                obs.isCoin = true;
            } else if (type < 0.5) { 
                obs.char = 'üíâ';
                obs.h = 60;
                obs.w = 30;
                obs.y = groundHeight - 60;
            } else if (type < 0.7) { 
                obs.char = 'üõèÔ∏è';
                obs.w = 70;
                obs.h = 40;
                obs.y = groundHeight - 40;
            } else {
                obs.y = groundHeight - 40;
            }
            obstacles.push(obs);
        }

        function createParticles(x, y, color, count) {
            const limit = window.innerWidth < 600 ? 3 : count;
            for(let i=0; i<limit; i++) {
                particles.push({
                    x: x,
                    y: y,
                    vx: (Math.random() - 0.5) * 300, 
                    vy: (Math.random() - 1) * 300,
                    life: 1,
                    color: color
                });
            }
        }

        function drawBackground(dt) {
            const logicalWidth = window.innerWidth;
            const logicalHeight = window.innerHeight;

            let grad = ctx.createLinearGradient(0, 0, 0, logicalHeight);
            grad.addColorStop(0, '#1e3a8a');
            grad.addColorStop(1, '#3b82f6');
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, logicalWidth, logicalHeight);

            houses.forEach((house) => {
                ctx.fillStyle = house.color;
                ctx.fillRect(house.x, house.y, house.w, house.h);
                
                ctx.fillStyle = '#fef08a';
                house.windows.forEach(win => {
                    ctx.fillRect(house.x + win.x, house.y + win.y, 8, 12);
                });
                
                house.x -= (currentSpeed * 0.5) * dt;
            });

            if(houses.length > 0 && houses[0].x + houses[0].w < -10) {
                let lastHouseX = houses[houses.length-1].x + houses[houses.length-1].w;
                houses.shift();
                generateHouse(lastHouseX);
            }

            ctx.fillStyle = '#1e293b';
            ctx.fillRect(0, groundHeight, logicalWidth, logicalHeight - groundHeight);
            
            ctx.fillStyle = '#334155';
            bgOffset -= currentSpeed * dt;
            if (bgOffset < -50) bgOffset = 0;
            for(let i=bgOffset; i<logicalWidth; i+=50) {
                ctx.fillRect(i, groundHeight, 40, 10);
            }
        }

        // --- ANA OYUN D√ñNG√úS√ú ---
        function gameLoop(timestamp) {
            if (!gameRunning) return;

            const dt = (timestamp - lastTime) / 1000;
            lastTime = timestamp;

            if (dt > 0.1) {
                requestAnimationFrame(gameLoop);
                return;
            }

            const logicalWidth = window.innerWidth;
            const logicalHeight = window.innerHeight;

            ctx.clearRect(0, 0, logicalWidth, logicalHeight);

            // Hƒ±zlanma (5'ten 20'ye √ßƒ±karƒ±ldƒ± - √áok daha hƒ±zlƒ± zorla≈üacak)
            currentSpeed += 20 * dt; 
            score += currentSpeed * 0.05 * dt;
            scoreVal.innerText = Math.floor(score);

            player.dy += gravity * dt;
            player.y += player.dy * dt;

            if (player.y + player.h > groundHeight) {
                player.y = groundHeight - player.h;
                player.dy = 0;
                player.grounded = true;
            } else {
                player.grounded = false;
            }

            // Engel Spawn Mesafesi (Hƒ±za g√∂re dinamik)
            const lastObs = obstacles[obstacles.length - 1];
            // Hƒ±z arttƒ±k√ßa engeller arasƒ± minimum mesafeyi de biraz a√ßƒ±yoruz ki oynanabilir kalsƒ±n
            const minDistance = 250 + (currentSpeed * 0.2); 
            
            if (!lastObs || (logicalWidth - lastObs.x > minDistance)) {
                 if(Math.random() < 0.6) spawnObstacle(); // %60 ≈üans
            }

            drawBackground(dt);

            ctx.font = `${player.h}px Arial`;
            ctx.textAlign = "left";
            ctx.textBaseline = "top";
            
            ctx.save();
            if (!player.grounded) {
                ctx.translate(player.x + player.w/2, player.y + player.h/2);
                ctx.rotate(-0.2);
                ctx.translate(-(player.x + player.w/2), -(player.y + player.h/2));
            }
            ctx.shadowColor = "rgba(0,0,0,0.5)";
            ctx.shadowBlur = 10;
            ctx.fillText(player.skin, player.x, player.y);
            ctx.restore();

            for (let i = 0; i < obstacles.length; i++) {
                let obs = obstacles[i];
                obs.x -= currentSpeed * dt;

                ctx.font = `${obs.h}px Arial`;
                ctx.shadowBlur = 0;
                
                if (obs.isCoin) {
                    let bob = Math.sin(timestamp * 0.005) * 5;
                    ctx.fillText(obs.char, obs.x, obs.y + bob);
                } else {
                    ctx.fillText(obs.char, obs.x, obs.y);
                }

                let p = 10; 
                if (
                    player.x + p < obs.x + obs.w - p &&
                    player.x + player.w - p > obs.x + p &&
                    player.y + p < obs.y + obs.h - p &&
                    player.y + player.h - p > obs.y + p
                ) {
                    if (obs.isCoin) {
                        coins++;
                        coinsVal.innerText = coins;
                        createParticles(obs.x, obs.y, '#fbbf24', 5);
                        obstacles.splice(i, 1);
                        i--;
                    } else {
                        createParticles(player.x, player.y, '#ef4444', 20);
                        gameOver();
                        return; 
                    }
                }

                if (obs.x + obs.w < -50) {
                    obstacles.splice(i, 1);
                    i--;
                }
            }

            particles.forEach((p, i) => {
                p.x += p.vx * dt;
                p.y += p.vy * dt;
                p.life -= 2.0 * dt; 
                if (p.life <= 0) particles.splice(i, 1);
                else {
                    ctx.globalAlpha = p.life;
                    ctx.fillStyle = p.color;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, 5, 0, Math.PI*2);
                    ctx.fill();
                    ctx.globalAlpha = 1.0;
                }
            });

            requestAnimationFrame(gameLoop);
        }

        function openShop() {
            startScreen.classList.add('hidden');
            shopScreen.classList.remove('hidden');
            shopCoinsVal.innerText = coins;
            updateShopGrid();
        }

        function updateShopGrid() {
            const grid = document.querySelector('.shop-grid');
            grid.innerHTML = '';
            Object.values(SKINS).forEach(skin => {
                const el = document.createElement('div');
                const isUnlocked = unlockedSkins.includes(skin.id);
                const isSelected = currentSkinId === skin.id;
                el.className = `shop-item ${!isUnlocked ? 'locked' : ''} ${isSelected ? 'selected' : ''}`;
                let btnText = isUnlocked ? (isSelected ? 'SE√áƒ∞LDƒ∞' : 'SE√á') : `${skin.cost} üíä`;
                let btnClass = isUnlocked ? (isSelected ? 'bg-green-600' : 'bg-blue-600') : (coins >= skin.cost ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-gray-500 cursor-not-allowed');
                el.innerHTML = `
                    <div class="text-4xl mb-2">${skin.icon}</div>
                    <div class="font-bold text-white text-sm mb-1">${skin.name}</div>
                    <div class="text-xs text-gray-300 mb-2">${skin.desc}</div>
                    <button class="w-full py-1 rounded text-white font-bold text-xs ${btnClass}">${btnText}</button>
                `;
                el.onclick = () => {
                    if (isUnlocked) {
                        currentSkinId = skin.id;
                        localStorage.setItem('dr_ozlem_current_skin', currentSkinId);
                        updateShopGrid();
                        updateCharIcon();
                    } else {
                        if (coins >= skin.cost) {
                            coins -= skin.cost;
                            unlockedSkins.push(skin.id);
                            localStorage.setItem('dr_ozlem_coins', coins);
                            localStorage.setItem('dr_ozlem_skins', JSON.stringify(unlockedSkins));
                            shopCoinsVal.innerText = coins;
                            currentSkinId = skin.id;
                            localStorage.setItem('dr_ozlem_current_skin', currentSkinId);
                            updateShopGrid();
                            updateCharIcon();
                        } else {
                            el.classList.add('animate-shake'); 
                        }
                    }
                };
                grid.appendChild(el);
            });
        }

        function updateCharIcon() {
            if(SKINS[currentSkinId]) currentCharIcon.innerText = SKINS[currentSkinId].icon;
        }
        function updateShopUI() { coinsVal.innerText = coins; }
        updateCharIcon();

    </script>
</body>
</html>