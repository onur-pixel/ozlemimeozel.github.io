<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dr. √ñzlem Ko≈üuyor üèÉ‚Äç‚ôÄÔ∏è</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Poppins:wght@400;800&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: #333;
            overflow: hidden;
            touch-action: none;
            font-family: 'Poppins', sans-serif;
        }

        #gameCanvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* --- ARAY√úZ KATMANI --- */
        .ui-layer {
            position: absolute; top: 20px; left: 20px; right: 20px; pointer-events: none;
            display: flex; justify-content: space-between; z-index: 20;
        }

        .hud-group { display: flex; gap: 10px; }

        .hud-box {
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 20px;
            border-radius: 50px;
            border-bottom: 5px solid #ddd;
            color: #333;
            font-size: 1.3rem;
            font-weight: 800;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: flex; align-items: center; gap: 10px;
            pointer-events: auto; /* Butonlara tƒ±klanabilsin */
        }

        /* PAUSE BUTONU */
        #pauseBtn {
            cursor: pointer; transition: transform 0.1s; background: #fff;
            border: 3px solid #333; width: 50px; height: 50px;
            justify-content: center; padding: 0; font-size: 1.5rem;
        }
        #pauseBtn:active { transform: scale(0.9); }

        /* --- Lƒ∞DER TABLOSU --- */
        #leaderboard {
            position: absolute; top: 50%; right: 20px; transform: translateY(-50%);
            background: #fff; border-radius: 20px;
            padding: 20px; width: 220px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3); z-index: 50;
            border: 4px solid #4facfe;
        }

        #leaderboard h3 {
            text-align: center; margin-bottom: 15px; color: #00f260; 
            font-family: 'Fredoka One', cursive; letter-spacing: 1px;
            background: -webkit-linear-gradient(#00f260, #0575E6); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        .score-item {
            display: flex; justify-content: space-between; margin-bottom: 8px;
            font-weight: bold; font-size: 0.9rem; padding: 8px 12px; border-radius: 10px;
            color: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .score-item:nth-child(2) { background: linear-gradient(45deg, #FFD700, #FDB931); } /* 1. Altƒ±n */
        .score-item:nth-child(3) { background: linear-gradient(45deg, #C0C0C0, #E0E0E0); } /* 2. G√ºm√º≈ü */
        .score-item:nth-child(4) { background: linear-gradient(45deg, #CD7F32, #D2691E); } /* 3. Bronz */

        /* --- MEN√úLER --- */
        .screen {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; 
            background: linear-gradient(135deg, #ffffff 0%, #f0f8ff 100%);
            padding: 40px;
            border-radius: 40px; border: 5px solid #4facfe;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            width: 90%; max-width: 450px; z-index: 100;
        }

        .hidden { display: none !important; }

        h1 { 
            font-family: 'Fredoka One', cursive; font-size: 2.5rem; margin-bottom: 15px;
            background: -webkit-linear-gradient(#00c6ff, #0072ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-shadow: 2px 2px 0px rgba(0,0,0,0.1);
        }
        
        input[type="text"] {
            width: 100%; padding: 15px; font-size: 1.2rem; border: 2px solid #ddd;
            border-radius: 50px; margin-bottom: 20px; font-family: 'Poppins', sans-serif;
            text-align: center; font-weight: bold; outline: none; transition: 0.3s;
        }
        input:focus { border-color: #4facfe; box-shadow: 0 0 10px rgba(79, 172, 254, 0.3); }

        .btn-primary {
            background: linear-gradient(45deg, #00c6ff, #0072ff);
            color: #fff; border: none; padding: 15px 40px; font-size: 1.2rem; font-weight: 900;
            border-radius: 50px; cursor: pointer; box-shadow: 0 10px 20px rgba(0, 114, 255, 0.3);
            transition: transform 0.1s; text-transform: uppercase; width: 100%; margin-top: 10px;
        }
        .btn-primary:active { transform: scale(0.95); }

        /* PAUSE EKRANI */
        #pauseScreen {
            background: rgba(255, 255, 255, 0.95); border: 5px solid #ff9f43;
        }
        #pauseScreen h1 {
            background: -webkit-linear-gradient(#ff9f43, #ff6b6b); -webkit-background-clip: text;
        }

        /* KUTLAMA */
        #celebrationMsg {
            position: absolute; top: 20%; width: 100%; text-align: center;
            font-size: 4rem; font-family: 'Fredoka One', cursive;
            color: #FFD700; -webkit-text-stroke: 3px #fff;
            text-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 50; pointer-events: none;
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

        .home-btn {
            position: absolute; bottom: 20px; left: 20px; background: #fff; padding: 10px 20px;
            border-radius: 50px; text-decoration: none; color: #333; font-weight: 800;
            box-shadow: 0 5px 10px rgba(0,0,0,0.1); z-index: 60; transition:0.2s;
        }
        .home-btn:hover { transform: translateY(-2px); }

    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <div class="ui-layer">
        <div class="hud-group">
            <div class="hud-box">üë§ <span id="playerNameDisplay">Misafir</span></div>
            <div class="hud-box">üíé <span id="scoreVal">0</span></div>
        </div>
        <div id="pauseBtn" class="hud-box" onclick="togglePause()">‚è∏Ô∏è</div>
    </div>

    <div id="leaderboard">
        <h3>üèÜ Lƒ∞DERLER</h3>
        <div id="scoreList">Y√ºkleniyor...</div>
    </div>

    <div id="celebrationMsg" class="hidden">100 PUAN! üéâ</div>
    <a href="index.html" class="home-btn">üè† √áƒ±kƒ±≈ü</a>

    <div id="nameScreen" class="screen">
        <h1>Dr. √ñzlem Ko≈üuyor</h1>
        <p style="color:#666; margin-bottom:20px;">Liderlik tablosuna girmek i√ßin ismini yaz:</p>
        <input type="text" id="nameInput" placeholder="Adƒ±nƒ±z..." maxlength="12">
        <button class="btn-primary" onclick="submitName()">OYUNA Gƒ∞R ‚ñ∂Ô∏è</button>
    </div>

    <div id="startScreen" class="screen hidden">
        <h1>HAZIRLAN!</h1>
        <p style="color:#555; margin-bottom:20px; font-size:1.1rem;">
            Zƒ±plamak i√ßin tƒ±kla veya bo≈üluk tu≈üuna bas.<br>
            <span style="color:#e74c3c; font-weight:bold;">Havadan gelenlere dikkat et (Eƒüil)!</span>
        </p>
        <button class="btn-primary" onclick="startGame()">KO≈ûMAYA BA≈ûLA üèÉ‚Äç‚ôÄÔ∏è</button>
    </div>

    <div id="pauseScreen" class="screen hidden">
        <h1>DURAKLATILDI</h1>
        <p style="color:#666; margin-bottom:20px;">Soluklan biraz...</p>
        <button class="btn-primary" onclick="togglePause()">DEVAM ET ‚ñ∂Ô∏è</button>
        <button class="btn-primary" style="background: #ff6b6b; margin-top:10px;" onclick="location.reload()">√áIKI≈û YAP</button>
    </div>

    <div id="gameOverScreen" class="screen hidden">
        <h1 style="background:none; -webkit-text-fill-color: initial; color:#ff4757;">√áARPTIN! üí•</h1>
        <p style="font-size:1.5rem; font-weight:bold; color:#333; margin-bottom:10px;">Skorun: <span id="finalScore">0</span></p>
        <p style="color:#888; font-size:0.9rem; margin-bottom:20px;">Listeye kaydedildi.</p>
        <button class="btn-primary" onclick="startGame()">TEKRAR DENE üîÑ</button>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBHejjQe2dHnwDYES3Qd30HKO94-_D5lVA",
            authDomain: "ask-oyunu-5d368.firebaseapp.com",
            databaseURL: "https://ask-oyunu-5d368-default-rtdb.firebaseio.com",
            projectId: "ask-oyunu-5d368",
            storageBucket: "ask-oyunu-5d368.firebasestorage.app",
            messagingSenderId: "550862375128",
            appId: "1:550862375128:web:fb49cef5e3c5440d996fad",
            measurementId: "G-T1GCW04QD0"
        };

        try {
            firebase.initializeApp(firebaseConfig);
            const db = firebase.database();
            const scoresRef = db.ref('runner_scores_v2'); 
            scoresRef.orderByChild('score').limitToLast(3).on('value', (snapshot) => {
                const list = document.getElementById('scoreList');
                list.innerHTML = "";
                let scores = [];
                snapshot.forEach((child) => { scores.push(child.val()); });
                scores.reverse().forEach((s, index) => {
                    let div = document.createElement('div');
                    div.className = 'score-item';
                    div.innerHTML = `<span>${index+1}. ${s.name}</span> <span>${s.score}</span>`;
                    list.appendChild(div);
                });
            });
        } catch(e) { console.error("Firebase Hatasƒ±:", e); }

        let playerName = "Misafir";
        function submitName() {
            const input = document.getElementById('nameInput').value.trim();
            if(input) {
                playerName = input;
                document.getElementById('playerNameDisplay').innerText = playerName;
                document.getElementById('nameScreen').classList.add('hidden');
                document.getElementById('startScreen').classList.remove('hidden');
            } else { alert("L√ºtfen bir isim girin!"); }
        }

        function saveScoreToDB(finalScore) {
            if(typeof firebase !== 'undefined' && finalScore > 0) {
                firebase.database().ref('runner_scores_v2').push({
                    name: playerName, score: finalScore, date: Date.now()
                });
            }
        }

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode); gainNode.connect(audioCtx.destination);

            if (type === 'jump') {
                osc.frequency.setValueAtTime(300, audioCtx.currentTime);
                osc.frequency.linearRampToValueAtTime(600, audioCtx.currentTime + 0.1);
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.1);
                osc.start(); osc.stop(audioCtx.currentTime + 0.1);
            } else if (type === 'coin') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(1200, audioCtx.currentTime);
                gainNode.gain.setValueAtTime(0.05, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
                osc.start(); osc.stop(audioCtx.currentTime + 0.1);
            } else if (type === 'celebrate') {
                const now = audioCtx.currentTime;
                [523, 659, 784, 1046].forEach((f,i)=>{
                    let o=audioCtx.createOscillator(); let g=audioCtx.createGain();
                    o.connect(g); g.connect(audioCtx.destination);
                    o.frequency.value=f;
                    g.gain.setValueAtTime(0.1, now+i*0.1); g.gain.linearRampToValueAtTime(0, now+i*0.1+0.2);
                    o.start(now+i*0.1); o.stop(now+i*0.1+0.2);
                });
            } else if (type === 'crash') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(100, audioCtx.currentTime);
                osc.frequency.linearRampToValueAtTime(0, audioCtx.currentTime+0.3);
                gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
                gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime+0.3);
                osc.start(); osc.stop(audioCtx.currentTime+0.3);
            }
        }

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let isPlaying = false;
        let isPaused = false;
        let score = 0;
        let gameSpeed = 0;
        let frames = 0;
        let celebrated100 = false;

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        const bgLayers = {
            clouds: { items: [], speed: 0.2 },
            mountains: { items: [], speed: 0.5 }
        };

        function initBG() {
            bgLayers.clouds.items = [];
            bgLayers.mountains.items = [];
            for(let i=0; i<6; i++) {
                bgLayers.clouds.items.push({ x: Math.random()*canvas.width, y: Math.random()*200, type: "‚òÅÔ∏è" });
                bgLayers.mountains.items.push({ x: i*300, y: canvas.height-160, type: "üèîÔ∏è" });
            }
        }

        const ground = {
            height: 120,
            y: 0,
            draw: function() {
                this.y = canvas.height - this.height;
                ctx.fillStyle = '#795548'; ctx.fillRect(0, this.y, canvas.width, this.height);
                ctx.fillStyle = '#4CAF50'; ctx.fillRect(0, this.y, canvas.width, 25);
                ctx.fillStyle = 'rgba(0,0,0,0.15)'; 
                for(let i=0; i<canvas.width; i+=150) {
                    // Duraklatƒ±ldƒ±ƒüƒ±nda √ßizgi kaymasƒ±n diye frames sabit kalƒ±yor zaten
                    let offset = (i - (frames*gameSpeed)) % canvas.width;
                    if(offset<0) offset+=canvas.width;
                    ctx.beginPath();
                    ctx.moveTo(offset, this.y+25);
                    ctx.lineTo(offset-40, canvas.height);
                    ctx.lineTo(offset, canvas.height);
                    ctx.lineTo(offset+40, this.y+25);
                    ctx.fill();
                }
            }
        };

        const player = {
            x: 80, y:0, w:60, h:80, dy:0, jumpForce:16, gravity:0.7, grounded:false, emoji:"üë©‚Äç‚öïÔ∏è", isDucking: false,
            draw: function() {
                if(this.grounded || this.y > canvas.height-300) {
                    ctx.fillStyle = 'rgba(0,0,0,0.2)';
                    ctx.beginPath(); ctx.ellipse(this.x+30, ground.y+15, 25, 8, 0, 0, Math.PI*2); ctx.fill();
                }
                
                let bounce = this.grounded ? Math.sin(frames*0.2)*5 : 0;
                
                ctx.font = this.isDucking ? "50px Arial" : "80px Arial";
                ctx.lineWidth = 4;
                ctx.strokeStyle = "white"; 
                ctx.lineJoin = "round";
                ctx.strokeText(this.emoji, this.x, this.y+70+bounce);
                
                ctx.fillStyle = "black"; 
                ctx.fillText(this.emoji, this.x, this.y+70+bounce);
            },
            update: function() {
                if(this.isDucking) { this.h = 45; this.gravity = 1.2; }
                else { this.h = 80; this.gravity = 0.7; }

                if(!this.grounded) { this.dy+=this.gravity; this.y+=this.dy; } else { this.dy=0; }
                if(this.y > ground.y - this.h + 10) {
                    this.y = ground.y - this.h + 10;
                    this.grounded = true;
                }
            },
            jump: function() {
                if(this.grounded && !this.isDucking) {
                    this.dy = -this.jumpForce; this.grounded = false; playSound('jump');
                }
            }
        };

        let obstacles = []; let rewards = [];

        function startGame() {
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('gameOverScreen').classList.add('hidden');
            document.getElementById('celebrationMsg').classList.add('hidden');
            score = 0; frames = 0; gameSpeed = 8;
            obstacles = []; rewards = []; celebrated100 = false;
            
            initBG();
            player.y = canvas.height - ground.height - player.h;
            updateScoreUI();
            
            isPlaying = true;
            isPaused = false;
            loop();
        }

        // --- PAUSE FONKSƒ∞YONU ---
        function togglePause() {
            if(!isPlaying) return; // Oyun ba≈ülamadƒ±ysa veya bittiyse √ßalƒ±≈üma
            
            isPaused = !isPaused;
            const pauseScreen = document.getElementById('pauseScreen');
            const pauseBtn = document.getElementById('pauseBtn');

            if(isPaused) {
                pauseScreen.classList.remove('hidden');
                pauseBtn.innerText = "‚ñ∂Ô∏è"; // Devam ikonu
            } else {
                pauseScreen.classList.add('hidden');
                pauseBtn.innerText = "‚è∏Ô∏è"; // Duraklat ikonu
                loop(); // D√∂ng√ºy√º tekrar ba≈ülat
            }
        }

        function updateScoreUI() { document.getElementById('scoreVal').innerText = score; }

        function spawn() {
            let minGap = 450 + (gameSpeed*10);
            let lastX = obstacles.length>0 ? obstacles[obstacles.length-1].x : 0;
            if(canvas.width - lastX > minGap) {
                if(Math.random() < 0.05) {
                    let type = Math.random();
                    let obs = { x: canvas.width, w:50, h:50, emoji:"ü¶†", isHigh:false };
                    if(type > 0.7) {
                        obs.emoji = "ü¶á"; obs.isHigh = true; obs.y = ground.y - 120; 
                    } else {
                        obs.y = ground.y - 55; 
                    }
                    obstacles.push(obs);
                    
                    if(Math.random() > 0.4) {
                        rewards.push({
                            x: canvas.width + 60 + Math.random()*200,
                            y: ground.y - (obs.isHigh ? 60 : 150),
                            w:40, h:40, emoji: Math.random()>0.7 ? "üíé" : "üíä"
                        });
                    }
                }
            }
        }

        function update() {
            // Pause kontrol√º: Duraklatƒ±ldƒ±ysa update yapma
            if(!isPlaying || isPaused) return;

            frames++;
            if(frames%600===0 && gameSpeed<25) gameSpeed+=0.5;
            player.update();
            spawn();

            for(let i=obstacles.length-1; i>=0; i--) {
                let o = obstacles[i]; o.x -= gameSpeed;
                
                let px = player.x + 15;
                let py = player.y + 15;
                let pw = player.w - 30;
                let ph = player.h - 30;

                if(px < o.x + o.w && px + pw > o.x &&
                   py < o.y + o.h && py + ph > o.y) {
                    gameOver();
                }
                
                if(o.x + o.w < 0) {
                    obstacles.splice(i,1); score++; updateScoreUI(); check100();
                }
            }

            for(let i=rewards.length-1; i>=0; i--) {
                let r = rewards[i]; r.x -= gameSpeed;
                if(player.x < r.x + r.w && player.x + player.w > r.x &&
                   player.y < r.y + r.h && player.y + player.h > r.y) {
                    playSound('coin'); score+=5; updateScoreUI(); check100(); rewards.splice(i,1);
                } else if(r.x+r.w < 0) rewards.splice(i,1);
            }
        }

        function check100() {
            if(score>=100 && !celebrated100) {
                celebrated100 = true; playSound('celebrate');
                let msg = document.getElementById('celebrationMsg');
                msg.classList.remove('hidden');
                setTimeout(()=>msg.classList.add('hidden'), 3000);
            }
        }

        function gameOver() {
            playSound('crash'); isPlaying = false;
            saveScoreToDB(score);
            document.getElementById('finalScore').innerText = score;
            document.getElementById('gameOverScreen').classList.remove('hidden');
        }

        function draw() {
            let grad = ctx.createLinearGradient(0,0,0,canvas.height);
            grad.addColorStop(0, '#87CEEB'); grad.addColorStop(1, '#E0F7FA');
            ctx.fillStyle = grad; ctx.fillRect(0,0,canvas.width,canvas.height);

            ctx.font = "120px Arial";
            bgLayers.mountains.items.forEach(m => {
                // Pause deƒüilse hareket et
                if(!isPaused && isPlaying) m.x -= bgLayers.mountains.speed;
                if(m.x < -200) m.x = canvas.width;
                ctx.globalAlpha = 1.0; 
                ctx.fillText(m.type, m.x, ground.y);
            });
            ctx.font = "80px Arial";
            bgLayers.clouds.items.forEach(c => {
                if(!isPaused && isPlaying) c.x -= bgLayers.clouds.speed;
                if(c.x < -100) c.x = canvas.width;
                ctx.globalAlpha = 0.9;
                ctx.fillStyle = "#fff"; 
                ctx.fillText(c.type, c.x, c.y);
            });
            ctx.globalAlpha = 1.0;

            ground.draw();
            player.draw();

            for(let o of obstacles) {
                ctx.font = "60px Arial";
                ctx.lineWidth = 4; ctx.strokeStyle = "white"; 
                ctx.strokeText(o.emoji, o.x, o.y+50);
                ctx.fillText(o.emoji, o.x, o.y+50);
            }
            for(let r of rewards) {
                ctx.font = "50px Arial";
                ctx.lineWidth = 4; ctx.strokeStyle = "gold";
                ctx.strokeText(r.emoji, r.x, r.y+40);
                ctx.fillText(r.emoji, r.x, r.y+40);
            }
        }

        function loop() {
            if(isPlaying) {
                if(!isPaused) update();
                draw(); // Pause olsa bile √ßizmeye devam et (Donmu≈ü g√∂r√ºnt√º)
                if(!isPaused) requestAnimationFrame(loop);
            }
        }

        // --- KONTROLLER ---
        function handleJump() { if(isPlaying && !isPaused) player.jump(); }
        function handleDuck(state) { if(isPlaying && !isPaused) player.isDucking = state; }

        window.addEventListener('keydown', e=>{ 
            if(e.code==='Space'||e.code==='ArrowUp') handleJump();
            if(e.code==='ArrowDown') handleDuck(true);
            if(e.code==='Escape') togglePause(); // ESC ile duraklat
        });
        window.addEventListener('keyup', e=>{
            if(e.code==='ArrowDown') handleDuck(false);
        });

        let touchStartY = 0;
        window.addEventListener('touchstart', e => {
            touchStartY = e.touches[0].clientY;
        }, {passive: false});
        
        window.addEventListener('touchend', e => {
            if(isPaused) return; // Pause iken dokunmatik i≈ülemesin
            let touchEndY = e.changedTouches[0].clientY;
            let diff = touchStartY - touchEndY;
            
            if (diff > 50) { 
                handleJump();
            } else if (diff < -50) { 
                player.isDucking = true;
                setTimeout(() => player.isDucking = false, 600); 
            } else {
                handleJump(); 
            }
        }, {passive: false});

    </script>
</body>
</html>