<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dr. √ñzlem: B√ºy√ºk Ko≈üu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto:wght@400;700&display=swap');

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #2563eb;
            font-family: 'Roboto', sans-serif;
            touch-action: none; /* Mobilde kaydƒ±rma ve zoom'u engelle */
            user-select: none;
            -webkit-user-select: none;
        }

        #gameCanvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        .pixel-font {
            font-family: 'Press Start 2P', cursive;
        }

        /* UI Katmanlarƒ± */
        .ui-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20;
            transition: opacity 0.3s;
        }

        /* Yarƒ± saydam arka planlar */
        .bg-overlay {
            background: rgba(15, 23, 42, 0.95);
        }

        /* Maƒüaza Grid */
        .shop-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
        }

        .shop-item {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #3b82f6;
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .shop-item.locked {
            opacity: 0.6;
            filter: grayscale(1);
        }

        .shop-item.selected {
            border-color: #fbbf24;
            background: rgba(251, 191, 36, 0.2);
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.4);
        }

        .shop-item:active {
            transform: scale(0.95);
        }

        /* Lider Tablosu */
        #leaderboard {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #fbbf24;
            border-radius: 8px;
            padding: 10px;
            color: white;
            z-index: 10;
            pointer-events: none;
            font-size: 10px;
            min-width: 150px;
        }

        /* Zƒ±plama Butonu (Mobil ƒ∞√ßin G√∂rsel Yardƒ±mcƒ±) */
        #mobile-jump-area {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 50%;
            z-index: 5; /* Canvas √ºzerinde ama UI altƒ±nda */
            display: none; /* JS ile mobilde a√ßƒ±labilir */
        }
        
        button:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body>

    <!-- Oyun Alanƒ± -->
    <canvas id="gameCanvas"></canvas>

    <!-- HUD (Oyun ƒ∞√ßi G√∂stergeler) -->
    <div id="hud" class="absolute top-0 left-0 w-full p-4 pointer-events-none flex justify-between z-10 hidden">
        <div class="text-white pixel-font text-xl drop-shadow-md">
            SKOR: <span id="score-val" class="text-yellow-400">0</span>
        </div>
        <div class="text-white pixel-font text-sm drop-shadow-md flex items-center gap-2">
            üíä <span id="coins-val">0</span>
        </div>
    </div>

    <!-- Global Lider Tablosu -->
    <div id="leaderboard">
        <div class="text-yellow-400 text-center mb-2 font-bold border-b border-gray-600 pb-1">üèÜ TOP 3 GLOBAL</div>
        <div id="leaderboard-list" class="space-y-1">
            <div class="text-gray-400 text-center">Y√ºkleniyor...</div>
        </div>
    </div>

    <!-- Ba≈ülangƒ±√ß Ekranƒ± -->
    <div id="start-screen" class="ui-screen bg-overlay">
        <div class="text-6xl mb-4 animate-bounce" id="current-char-icon">üë©‚Äç‚öïÔ∏è</div>
        <h1 class="pixel-font text-3xl md:text-5xl text-white mb-2 text-center text-shadow-lg">
            DR. √ñZLEM<br><span class="text-yellow-400 text-2xl md:text-4xl">ZORLU KO≈ûU</span>
        </h1>
        
        <div class="bg-white/10 backdrop-blur-md p-6 rounded-xl border border-white/20 w-80 text-center mt-4">
            <input type="text" id="player-name" placeholder="ADINIZ (MAX 10)" maxlength="10" 
                class="w-full bg-slate-800 text-white border-2 border-blue-500 rounded px-4 py-3 mb-4 text-center pixel-font focus:outline-none focus:border-yellow-400 uppercase">
            
            <button id="start-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 rounded-lg pixel-font shadow-lg border-b-4 border-green-700 mb-3">
                KO≈ûUYA BA≈ûLA
            </button>
            
            <button id="shop-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-lg pixel-font shadow-lg border-b-4 border-blue-700 text-sm">
                üè• ECZANE (MAƒûAZA)
            </button>
        </div>
        <div class="text-gray-400 mt-4 text-xs">Masa√ºst√º: Space/Tƒ±kla ‚Ä¢ Mobil: Dokun</div>
    </div>

    <!-- Maƒüaza Ekranƒ± -->
    <div id="shop-screen" class="ui-screen bg-overlay hidden">
        <h2 class="pixel-font text-2xl text-yellow-400 mb-6">ECZANE</h2>
        <div class="text-white mb-4">BAKƒ∞YENƒ∞Z: <span id="shop-coins" class="text-green-400 font-bold">0</span> üíä</div>
        
        <div class="shop-grid bg-slate-800 p-4 rounded-xl border border-slate-600 w-11/12 max-w-md">
            <!-- Market √ñƒüeleri JS ile Doldurulacak -->
        </div>

        <button id="close-shop-btn" class="mt-6 bg-red-500 hover:bg-red-600 text-white py-3 px-8 rounded-lg pixel-font border-b-4 border-red-700">
            KAPAT
        </button>
    </div>

    <!-- Oyun Bitti Ekranƒ± -->
    <div id="game-over-screen" class="ui-screen bg-overlay hidden">
        <h1 class="pixel-font text-red-500 text-4xl mb-4 drop-shadow-lg">YANDIN!</h1>
        <div class="text-white text-xl mb-2">TOPLANAN SKOR</div>
        <div id="final-score" class="pixel-font text-yellow-400 text-5xl mb-8">0</div>
        
        <div class="flex gap-4">
            <button id="restart-btn" class="bg-green-500 hover:bg-green-600 text-white py-4 px-8 rounded-lg pixel-font border-b-4 border-green-700 shadow-xl">
                TEKRAR
            </button>
            <button id="menu-btn" class="bg-gray-500 hover:bg-gray-600 text-white py-4 px-6 rounded-lg pixel-font border-b-4 border-gray-700 shadow-xl">
                MEN√ú
            </button>
        </div>
    </div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE KURULUMU ---
        const firebaseConfig = JSON.parse(new URLSearchParams(window.location.search).get('__firebase_config')) || JSON.parse(__firebase_config);
        const appId = new URLSearchParams(window.location.search).get('__app_id') || (typeof __app_id !== 'undefined' ? __app_id : 'default-app');
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;

        // Oturum A√ßma
        const initAuth = async () => {
             if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                try {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } catch(e) { await signInAnonymously(auth); }
            } else {
                await signInAnonymously(auth);
            }
        };
        initAuth();

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) listenLeaderboard();
        });

        // Global Leaderboard Dinleme (Sadece Top 3)
        function listenLeaderboard() {
            const q = query(
                collection(db, 'artifacts', appId, 'public', 'data', 'dr_ozlem_global_scores'),
                orderBy('score', 'desc'),
                limit(3)
            );
            
            onSnapshot(q, (snapshot) => {
                const listEl = document.getElementById('leaderboard-list');
                listEl.innerHTML = '';
                let rank = 1;
                
                if (snapshot.empty) {
                    listEl.innerHTML = '<div class="text-center text-gray-500 text-xs">Hen√ºz skor yok</div>';
                    return;
                }

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const row = document.createElement('div');
                    row.className = 'flex justify-between text-xs border-b border-gray-700 pb-1 mb-1';
                    
                    let medal = rank === 1 ? 'ü•á' : (rank === 2 ? 'ü•à' : 'ü•â');
                    let name = data.name.substring(0, 8); // ƒ∞smi kƒ±salt
                    
                    row.innerHTML = `
                        <span class="text-white">${medal} ${name}</span>
                        <span class="text-green-400 font-bold">${Math.floor(data.score)}</span>
                    `;
                    listEl.appendChild(row);
                    rank++;
                });
            }, (error) => console.error("Leaderboard hatasƒ±:", error));
        }

        // Skor Kaydetme
        window.saveScoreToFirebase = async function(score) {
            if (!currentUser || score < 10) return; // √áok d√º≈ü√ºk skorlarƒ± kaydetme
            const playerName = document.getElementById('player-name').value.trim() || "Dr. Anonim";
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'dr_ozlem_global_scores'), {
                    name: playerName,
                    score: Math.floor(score),
                    userId: currentUser.uid,
                    timestamp: serverTimestamp()
                });
            } catch (e) { console.error("Skor kaydedilemedi", e); }
        };
    </script>

    <!-- Oyun Mantƒ±ƒüƒ± -->
    <script>
        // --- OYUN DEƒûƒ∞≈ûKENLERƒ∞ ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // UI Elementleri
        const startScreen = document.getElementById('start-screen');
        const gameOverScreen = document.getElementById('game-over-screen');
        const shopScreen = document.getElementById('shop-screen');
        const hud = document.getElementById('hud');
        const scoreVal = document.getElementById('score-val');
        const coinsVal = document.getElementById('coins-val');
        const finalScoreVal = document.getElementById('final-score');
        const shopCoinsVal = document.getElementById('shop-coins');
        const currentCharIcon = document.getElementById('current-char-icon');

        // Oyun Durumu
        let gameRunning = false;
        let score = 0;
        let coins = parseInt(localStorage.getItem('dr_ozlem_coins')) || 0;
        let gameSpeed = 6;
        let gravity = 0.6;
        let frames = 0;
        let unlockedSkins = JSON.parse(localStorage.getItem('dr_ozlem_skins')) || ['default'];
        let currentSkinId = localStorage.getItem('dr_ozlem_current_skin') || 'default';

        // Karakter Tanƒ±mlarƒ± (Maƒüaza)
        const SKINS = {
            'default': { id: 'default', name: 'Dr. √ñzlem', icon: 'üë©‚Äç‚öïÔ∏è', cost: 0, desc: 'Standart √úniforma' },
            'surgeon': { id: 'surgeon', name: 'Cerrah', icon: 'üò∑', cost: 200, desc: 'Ameliyathane Hazƒ±r' },
            'scientist': { id: 'scientist', name: 'Bilim ƒ∞nsanƒ±', icon: 'üßë‚Äçüî¨', cost: 500, desc: 'Laboratuvar Ustasƒ±' },
            'super': { id: 'super', name: 'S√ºper Dr.', icon: 'ü¶∏‚Äç‚ôÄÔ∏è', cost: 1000, desc: 'Hƒ±zlƒ± ve √ñfkeli' },
            'zombie': { id: 'zombie', name: 'Zombi Dr.', icon: 'üßü‚Äç‚ôÄÔ∏è', cost: 2000, desc: 'Beyin Cerrahƒ±!' }
        };

        // Oyuncu Objesi
        let player = {
            x: 50,
            y: 0,
            w: 50,
            h: 80,
            dy: 0,
            jumpPower: -14,
            grounded: false,
            skin: SKINS[currentSkinId].icon
        };

        let obstacles = [];
        let particles = [];
        let houses = []; // Evler i√ßin dizi
        let groundHeight = 100;
        
        // Arka Plan Paralaks
        let bgOffset = 0;
        
        // --- BA≈ûLANGI√á & EVENT LISTENERS ---
        
        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            groundHeight = canvas.height - 120;
            if(!gameRunning) player.y = groundHeight - player.h;
        }
        window.addEventListener('resize', resize);
        resize();

        // Butonlar
        document.getElementById('start-btn').addEventListener('click', startGame);
        document.getElementById('restart-btn').addEventListener('click', startGame);
        
        // Mobil uyumluluƒüu i√ßin start butonuna touchstart da ekleyelim
        document.getElementById('start-btn').addEventListener('touchstart', (e) => {
            e.preventDefault(); // Ghost click √∂nle
            startGame();
        });

        document.getElementById('menu-btn').addEventListener('click', () => {
            gameOverScreen.classList.add('hidden');
            startScreen.classList.remove('hidden');
            hud.classList.add('hidden');
            updateShopUI();
        });

        // Maƒüaza Butonlarƒ±
        document.getElementById('shop-btn').addEventListener('click', openShop);
        document.getElementById('close-shop-btn').addEventListener('click', () => {
            shopScreen.classList.add('hidden');
            startScreen.classList.remove('hidden');
            updateCharIcon();
        });

        // Zƒ±plama Kontrolleri
        function jump() {
            if (player.grounded && gameRunning) {
                player.dy = player.jumpPower;
                player.grounded = false;
                createParticles(player.x + player.w/2, player.y + player.h, '#fff', 5);
            }
        }

        window.addEventListener('keydown', (e) => {
            if ((e.code === 'Space' || e.code === 'ArrowUp') && gameRunning) jump();
        });

        // Global Touch Listener (Oyun i√ßin)
        window.addEventListener('touchstart', (e) => {
            // Eƒüer butona basƒ±lmadƒ±ysa ve oyun a√ßƒ±ksa zƒ±pla
            if (gameRunning && !e.target.closest('button')) {
                e.preventDefault(); 
                jump();
            }
        }, { passive: false });

        window.addEventListener('mousedown', (e) => {
            if (gameRunning && !e.target.closest('button')) jump();
        });

        // --- OYUN FONKSƒ∞YONLARI ---

        // Yeni Ev Olu≈üturma
        function generateHouse(x) {
            let h = 80 + Math.random() * 120; // Y√ºkseklik
            let w = 60 + Math.random() * 80;  // Geni≈ülik
            
            // Renk paleti (Gece/≈ûehir temalƒ±)
            const colors = ['#334155', '#475569', '#1e293b', '#0f172a'];
            const color = colors[Math.floor(Math.random() * colors.length)];

            let house = {
                x: x,
                y: groundHeight - h,
                w: w,
                h: h,
                color: color,
                windows: []
            };

            // Pencereleri olu≈ütur
            let rows = Math.floor(h / 25);
            let cols = Math.floor(w / 20);

            for(let r=0; r<rows; r++) {
                for(let c=0; c<cols; c++) {
                    // %40 ihtimalle yanan pencere
                    if(Math.random() > 0.6) {
                        house.windows.push({
                            x: 10 + c * 20,
                            y: 10 + r * 25
                        });
                    }
                }
            }
            houses.push(house);
        }

        function initGame() {
            player.y = groundHeight - player.h;
            player.dy = 0;
            player.grounded = true;
            player.skin = SKINS[currentSkinId].icon;
            
            score = 0;
            gameSpeed = 6; // Ba≈ülangƒ±√ß hƒ±zƒ±
            obstacles = [];
            particles = [];
            houses = []; // Evleri sƒ±fƒ±rla
            frames = 0;
            
            // Ba≈ülangƒ±√ß evlerini doldur
            let hx = 0;
            while(hx < canvas.width + 200) {
                generateHouse(hx);
                hx += houses[houses.length-1].w;
            }

            scoreVal.innerText = '0';
            coinsVal.innerText = coins;
        }

        function startGame() {
            const nameInput = document.getElementById('player-name');
            if (!nameInput.value.trim()) {
                nameInput.classList.add('border-red-500', 'animate-pulse');
                setTimeout(() => nameInput.classList.remove('border-red-500', 'animate-pulse'), 500);
                return;
            }

            // Ekranlarƒ± Y√∂net
            startScreen.classList.add('hidden');
            gameOverScreen.classList.add('hidden');
            shopScreen.classList.add('hidden');
            hud.classList.remove('hidden');

            initGame();
            gameRunning = true;
            requestAnimationFrame(gameLoop);
        }

        function gameOver() {
            gameRunning = false;
            finalScoreVal.innerText = Math.floor(score);
            
            // Firebase'e kaydet (Global fonksiyon window'da tanƒ±mlƒ±)
            if (window.saveScoreToFirebase) {
                window.saveScoreToFirebase(score);
            }
            
            // Coinleri kaydet
            localStorage.setItem('dr_ozlem_coins', coins);

            gameOverScreen.classList.remove('hidden');
            hud.classList.add('hidden');
        }

        function spawnObstacle() {
            // Zorluk arttƒ±k√ßa daha sƒ±k ve √ße≈üitli engeller
            let type = Math.random();
            let obs = {
                x: canvas.width,
                y: groundHeight,
                w: 40,
                h: 40,
                char: 'ü¶†', // Varsayƒ±lan vir√ºs
                isCoin: false
            };

            if (type < 0.2) { // %20 ƒ∞la√ß (Para)
                obs.char = 'üíä';
                obs.y = groundHeight - 60 - Math.random() * 80; // Havada olabilir
                obs.w = 30;
                obs.h = 30;
                obs.isCoin = true;
            } else if (type < 0.5) { // ≈ûƒ±rƒ±nga (Uzun engel)
                obs.char = 'üíâ';
                obs.h = 60;
                obs.w = 30;
                obs.y = groundHeight - 60;
            } else if (type < 0.7) { // Yatak (Geni≈ü engel)
                obs.char = 'üõèÔ∏è';
                obs.w = 70;
                obs.h = 40;
                obs.y = groundHeight - 40;
            }
            // Aksi takdirde Vir√ºs (K√º√ß√ºk engel)
            else {
                obs.y = groundHeight - 40;
            }

            obstacles.push(obs);
        }

        function createParticles(x, y, color, count) {
            for(let i=0; i<count; i++) {
                particles.push({
                    x: x,
                    y: y,
                    vx: (Math.random() - 0.5) * 8,
                    vy: (Math.random() - 1) * 8,
                    life: 1,
                    color: color
                });
            }
        }

        function drawBackground() {
            // G√∂ky√ºz√º Gradient
            let grad = ctx.createLinearGradient(0, 0, 0, canvas.height);
            grad.addColorStop(0, '#1e3a8a');
            grad.addColorStop(1, '#3b82f6');
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // --- EVLERƒ∞ √áƒ∞Z (ZEMƒ∞Nƒ∞N ARKASINDA) ---
            houses.forEach((house, index) => {
                // Evi √áiz
                ctx.fillStyle = house.color;
                ctx.fillRect(house.x, house.y, house.w, house.h);
                
                // Pencereleri √áiz
                ctx.fillStyle = '#fef08a'; // Sarƒ± ƒ±≈üƒ±k
                house.windows.forEach(win => {
                    ctx.fillRect(house.x + win.x, house.y + win.y, 8, 12);
                });

                // Paralaks Hareketi (Daha yava≈ü hareket)
                // Oyun hƒ±zƒ±nƒ±n yarƒ±sƒ± kadar hareket etsinler
                house.x -= gameSpeed * 0.5;
            });

            // Evleri Y√∂net (Ekrandan √ßƒ±kanlarƒ± sil, yenisini ekle)
            if(houses.length > 0 && houses[0].x + houses[0].w < -10) {
                let lastHouseX = houses[houses.length-1].x + houses[houses.length-1].w;
                houses.shift(); // ƒ∞lki sil
                generateHouse(lastHouseX); // Sona ekle
            }

            // --- ZEMƒ∞N (√ñN PLAN) ---
            ctx.fillStyle = '#1e293b';
            ctx.fillRect(0, groundHeight, canvas.width, canvas.height - groundHeight);
            
            // Zemin √áizgileri (Hƒ±z hissi i√ßin)
            ctx.fillStyle = '#334155';
            bgOffset -= gameSpeed;
            if (bgOffset < -50) bgOffset = 0;
            for(let i=bgOffset; i<canvas.width; i+=50) {
                ctx.fillRect(i, groundHeight, 40, 10);
            }
        }

        function gameLoop() {
            if (!gameRunning) return;

            // Temizlik
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Fizik & G√ºncelleme
            frames++;
            gameSpeed += 0.001; // Giderek hƒ±zlan (Zorluk)
            score += gameSpeed * 0.05;
            scoreVal.innerText = Math.floor(score);

            player.dy += gravity;
            player.y += player.dy;

            // Zemin √áarpƒ±≈ümasƒ±
            if (player.y + player.h > groundHeight) {
                player.y = groundHeight - player.h;
                player.dy = 0;
                player.grounded = true;
            } else {
                player.grounded = false;
            }

            // Engel Spawn (Hƒ±zlandƒ±k√ßa daha sƒ±k)
            let spawnRate = Math.max(40, 100 - Math.floor(gameSpeed * 2));
            if (frames % spawnRate === 0 || Math.random() < 0.005) {
                if (obstacles.length === 0 || canvas.width - obstacles[obstacles.length-1].x > 250) {
                    spawnObstacle();
                }
            }

            // √áizimler
            drawBackground();

            // Oyuncu √áiz
            ctx.font = `${player.h}px Arial`;
            ctx.textAlign = "left";
            ctx.textBaseline = "top";
            
            // Zƒ±plarken hafif d√∂nme efekti
            ctx.save();
            if (!player.grounded) {
                ctx.translate(player.x + player.w/2, player.y + player.h/2);
                ctx.rotate(-0.2);
                ctx.translate(-(player.x + player.w/2), -(player.y + player.h/2));
            }
            // G√∂lge
            ctx.shadowColor = "rgba(0,0,0,0.5)";
            ctx.shadowBlur = 10;
            ctx.fillText(player.skin, player.x, player.y);
            ctx.restore();

            // Engelleri Y√∂net
            for (let i = 0; i < obstacles.length; i++) {
                let obs = obstacles[i];
                obs.x -= gameSpeed;

                // √áiz
                ctx.font = `${obs.h}px Arial`;
                ctx.shadowBlur = 0;
                
                if (obs.isCoin) {
                     // Coin Efekti
                    let bob = Math.sin(frames * 0.1) * 5;
                    ctx.fillText(obs.char, obs.x, obs.y + bob);
                } else {
                    ctx.fillText(obs.char, obs.x, obs.y);
                }

                // √áarpƒ±≈üma Kontrol√º (Basit AABB)
                // Tolerans (padding) ekleyelim ki oyun √ßok acƒ±masƒ±z olmasƒ±n
                let p = 10; 
                if (
                    player.x + p < obs.x + obs.w - p &&
                    player.x + player.w - p > obs.x + p &&
                    player.y + p < obs.y + obs.h - p &&
                    player.y + player.h - p > obs.y + p
                ) {
                    if (obs.isCoin) {
                        // Para toplandƒ±
                        coins++;
                        coinsVal.innerText = coins;
                        createParticles(obs.x, obs.y, '#fbbf24', 5);
                        obstacles.splice(i, 1);
                        i--;
                    } else {
                        // √áarpƒ±≈üma = √ñl√ºm
                        createParticles(player.x, player.y, '#ef4444', 20);
                        gameOver();
                        return;
                    }
                }

                // Ekrandan √ßƒ±kma
                if (obs.x + obs.w < 0) {
                    obstacles.splice(i, 1);
                    i--;
                }
            }

            // Par√ßacƒ±klar
            particles.forEach((p, i) => {
                p.x += p.vx;
                p.y += p.vy;
                p.life -= 0.05;
                if (p.life <= 0) particles.splice(i, 1);
                else {
                    ctx.globalAlpha = p.life;
                    ctx.fillStyle = p.color;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, 5, 0, Math.PI*2);
                    ctx.fill();
                    ctx.globalAlpha = 1.0;
                }
            });

            requestAnimationFrame(gameLoop);
        }

        // --- MAƒûAZA MANTIƒûI ---

        function openShop() {
            startScreen.classList.add('hidden');
            shopScreen.classList.remove('hidden');
            shopCoinsVal.innerText = coins;
            updateShopGrid();
        }

        function updateShopGrid() {
            const grid = document.querySelector('.shop-grid');
            grid.innerHTML = '';

            Object.values(SKINS).forEach(skin => {
                const el = document.createElement('div');
                const isUnlocked = unlockedSkins.includes(skin.id);
                const isSelected = currentSkinId === skin.id;

                el.className = `shop-item ${!isUnlocked ? 'locked' : ''} ${isSelected ? 'selected' : ''}`;
                
                let btnText = isUnlocked ? (isSelected ? 'SE√áƒ∞LDƒ∞' : 'SE√á') : `${skin.cost} üíä`;
                let btnClass = isUnlocked ? (isSelected ? 'bg-green-600' : 'bg-blue-600') : (coins >= skin.cost ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-gray-500 cursor-not-allowed');

                el.innerHTML = `
                    <div class="text-4xl mb-2">${skin.icon}</div>
                    <div class="font-bold text-white text-sm mb-1">${skin.name}</div>
                    <div class="text-xs text-gray-300 mb-2">${skin.desc}</div>
                    <button class="w-full py-1 rounded text-white font-bold text-xs ${btnClass}">
                        ${btnText}
                    </button>
                `;

                // Tƒ±klama Olayƒ±
                el.onclick = () => {
                    if (isUnlocked) {
                        currentSkinId = skin.id;
                        localStorage.setItem('dr_ozlem_current_skin', currentSkinId);
                        updateShopGrid();
                        updateCharIcon();
                    } else {
                        if (coins >= skin.cost) {
                            coins -= skin.cost;
                            unlockedSkins.push(skin.id);
                            localStorage.setItem('dr_ozlem_coins', coins);
                            localStorage.setItem('dr_ozlem_skins', JSON.stringify(unlockedSkins));
                            shopCoinsVal.innerText = coins;
                            // Otomatik se√ß
                            currentSkinId = skin.id;
                            localStorage.setItem('dr_ozlem_current_skin', currentSkinId);
                            updateShopGrid();
                            updateCharIcon();
                        } else {
                            // Yetersiz bakiye animasyonu
                            el.classList.add('animate-shake'); // CSS'de tanƒ±mlƒ± deƒüil ama sallansƒ±n
                        }
                    }
                };
                grid.appendChild(el);
            });
        }

        function updateCharIcon() {
            if(SKINS[currentSkinId]) {
                currentCharIcon.innerText = SKINS[currentSkinId].icon;
            }
        }
        
        function updateShopUI() {
            coinsVal.innerText = coins;
        }

        // Ba≈ülangƒ±√ß Ayarƒ±
        updateCharIcon();

    </script>
</body>
</html>