<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dr. √ñzlem: Engel Atlamaca</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto:wght@400;700&display=swap');

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #87CEEB; /* Daha canlƒ± bir g√∂ky√ºz√º mavisi */
            font-family: 'Roboto', sans-serif;
            touch-action: manipulation;
        }

        #gameCanvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* UI Katmanlarƒ± */
        .ui-layer {
            position: absolute;
            pointer-events: none;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* Lider Tablosu */
        #leaderboard-container {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 200px;
            background: rgba(255, 255, 255, 0.95);
            border: 3px solid #2563eb;
            border-radius: 12px;
            padding: 10px;
            color: #1e3a8a;
            z-index: 10;
            font-size: 0.75rem;
            pointer-events: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        #leaderboard-title {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.6rem;
            color: #dc2626;
            margin-bottom: 8px;
            text-align: center;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 5px;
        }

        .score-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-weight: bold;
        }

        /* Ba≈ülangƒ±√ß ve Biti≈ü Ekranlarƒ± */
        #start-screen, #game-over-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(30, 58, 138, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20;
        }

        .pixel-font {
            font-family: 'Press Start 2P', cursive;
        }

        /* Skor G√∂stergesi */
        #score-display {
            position: absolute;
            top: 10px;
            left: 10px;
            font-family: 'Press Start 2P', cursive;
            color: #1e3a8a;
            font-size: 1.4rem;
            text-shadow: 2px 2px 0 #fff, -1px -1px 0 #fff;
            pointer-events: none;
            background: rgba(255,255,255,0.6);
            padding: 5px 10px;
            border-radius: 8px;
        }
        
        /* Zƒ±plama ƒ∞pucu */
        #jump-hint {
            position: absolute;
            bottom: 25%;
            width: 100%;
            text-align: center;
            color: rgba(255, 255, 255, 0.9);
            font-weight: bold;
            font-size: 1.5rem;
            pointer-events: none;
            animation: pulse 1.2s infinite;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 0.8; }
        }
    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>
    <div id="jump-hint">ZIPLAMAK ƒ∞√áƒ∞N DOKUN!</div>

    <!-- UI: Skor -->
    <div id="score-display">0</div>

    <!-- UI: Lider Tablosu -->
    <div id="leaderboard-container">
        <div id="leaderboard-title">EN ƒ∞Yƒ∞ KO≈ûUCULAR</div>
        <div id="leaderboard-list">
            <div class="text-center text-gray-400">Y√ºkleniyor...</div>
        </div>
    </div>

    <!-- UI: Ba≈ülangƒ±√ß Ekranƒ± -->
    <div id="start-screen">
        <div class="text-7xl mb-6 animate-bounce">üë©‚Äç‚öïÔ∏è</div>
        <h1 class="pixel-font text-2xl md:text-4xl text-white mb-2 text-center leading-normal">DR. √ñZLEM<br><span class="text-yellow-400">ENGEL KO≈ûUSU</span></h1>
        
        <div class="bg-white p-6 rounded-xl shadow-2xl text-center max-w-sm mx-4 mt-4 w-full border-4 border-blue-500">
            <p class="text-gray-800 mb-4 font-bold text-lg">
                Engellerin √ºst√ºnden atla!<br>
                <span class="text-sm text-blue-600 font-normal">(Ekrana Dokun veya Space Tu≈üu)</span>
            </p>
            <input type="text" id="player-name-input" placeholder="DOKTOR ƒ∞SMƒ∞" maxlength="12" 
                class="bg-blue-50 text-blue-900 border-2 border-blue-300 rounded-lg px-4 py-3 mb-4 w-full text-center focus:outline-none focus:border-blue-600 font-bold uppercase tracking-wider">
            <button id="start-btn" class="w-full bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-700 hover:to-blue-600 text-white font-bold py-4 px-8 rounded-lg pixel-font transform transition hover:scale-105 shadow-lg border-b-4 border-blue-800">
                KO≈ûUYA BA≈ûLA
            </button>
        </div>
    </div>

    <!-- UI: Oyun Bitti Ekranƒ± -->
    <div id="game-over-screen" style="display: none;">
        <h1 class="pixel-font text-red-500 text-3xl md:text-4xl mb-4 text-center" style="text-shadow: 2px 2px 0 #fff;">√áARPI≈ûMA!</h1>
        <div class="text-white text-xl mb-2">SKORUNUZ</div>
        <div id="final-score" class="pixel-font text-yellow-400 text-5xl mb-8 drop-shadow-lg">0</div>
        <button id="restart-btn" class="bg-white hover:bg-gray-100 text-blue-900 font-bold py-4 px-8 rounded-lg pixel-font transform transition hover:scale-105 border-b-4 border-gray-300 shadow-xl">
            TEKRAR DENE
        </button>
    </div>

    <!-- Firebase Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(new URLSearchParams(window.location.search).get('__firebase_config')) || JSON.parse(__firebase_config);
        const appId = new URLSearchParams(window.location.search).get('__app_id') || (typeof __app_id !== 'undefined' ? __app_id : 'default-app');
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let globalHighScores = [];

        const initAuth = async () => {
             if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                try {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } catch(e) { console.error("Token fail", e); await signInAnonymously(auth); }
            } else {
                await signInAnonymously(auth);
            }
        };
        initAuth();

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) listenToLeaderboard();
        });

        function listenToLeaderboard() {
            const scoresRef = collection(db, 'artifacts', appId, 'public', 'data', 'dr_ozlem_jump_scores');
            
            onSnapshot(scoresRef, (snapshot) => {
                const scores = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.score && data.name) scores.push(data);
                });
                scores.sort((a, b) => b.score - a.score);
                globalHighScores = scores.slice(0, 5);
                updateLeaderboardUI();
            }, (error) => console.error(error));
        }

        function updateLeaderboardUI() {
            const listEl = document.getElementById('leaderboard-list');
            listEl.innerHTML = '';
            if (globalHighScores.length === 0) {
                listEl.innerHTML = '<div class="text-center text-gray-500 text-xs">Liste Bo≈ü</div>';
                return;
            }
            globalHighScores.forEach((s, index) => {
                const row = document.createElement('div');
                row.className = 'score-row';
                let name = s.name.length > 8 ? s.name.substring(0, 8) + '..' : s.name;
                name = name.replace(/[^\w\sƒü√º≈üƒ±√∂√ßƒû√ú≈ûƒ∞√ñ√á.]/gi, ''); 
                
                row.innerHTML = `
                    <span>${index + 1}. ${name}</span>
                    <span>${Math.floor(s.score)}</span>
                `;
                listEl.appendChild(row);
            });
        }

        async function saveScore(score) {
            if (!currentUser || score <= 0) return;
            const playerName = document.getElementById('player-name-input').value.trim() || "Dr. Bilinmeyen";
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'dr_ozlem_jump_scores'), {
                    name: playerName,
                    score: Math.floor(score),
                    userId: currentUser.uid,
                    timestamp: serverTimestamp()
                });
            } catch (e) { console.error("Save failed", e); }
        }

        // --- PLATFORM OYUN MOTORU ---
        
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreDisplay = document.getElementById('score-display');
        const finalScoreDisplay = document.getElementById('final-score');
        const startScreen = document.getElementById('start-screen');
        const gameOverScreen = document.getElementById('game-over-screen');
        const jumpHint = document.getElementById('jump-hint');

        let gameRunning = false;
        let score = 0;
        let gameSpeed = 5;
        let frameCount = 0;

        let doctor = {
            x: 60,
            y: 0,
            width: 50,
            height: 80, 
            dy: 0,
            jumpPower: -18,
            gravity: 0.8,
            grounded: false,
            sprite: "üë©‚Äç‚öïÔ∏è"
        };

        let obstacles = [];
        let particles = [];
        let groundHeight = 100;
        
        // Bina/Ev Prosed√ºrel √áizimi i√ßin veriler
        let buildings = [];

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            groundHeight = canvas.height - 100;
            if(!gameRunning) {
                 doctor.y = groundHeight - doctor.height;
            }
            // Bina listesini sƒ±fƒ±rla ki resize olunca bozulmasƒ±n
            buildings = [];
            generateBuildings();
        }
        window.addEventListener('resize', resize);
        
        function generateBuildings() {
            // Ekranƒ± dolduracak kadar bina √ºret
            let currentX = -100;
            while(currentX < canvas.width + 200) {
                const width = 80 + Math.random() * 100;
                const height = 150 + Math.random() * 200;
                // Pastel renkli evler
                const colors = ['#fecaca', '#bfdbfe', '#bbf7d0', '#ddd6fe', '#fde68a'];
                const color = colors[Math.floor(Math.random() * colors.length)];
                
                buildings.push({
                    x: currentX,
                    y: groundHeight - height,
                    w: width,
                    h: height,
                    color: color,
                    windows: []
                });
                
                // Pencereleri olu≈ütur
                const floors = Math.floor(height / 40);
                const cols = Math.floor(width / 30);
                for(let f=0; f<floors; f++) {
                    for(let c=0; c<cols; c++) {
                        if(Math.random() > 0.3) { // Her yerde pencere olmasƒ±n
                            buildings[buildings.length-1].windows.push({
                                x: 5 + c * 25,
                                y: 10 + f * 35,
                                w: 15,
                                h: 20
                            });
                        }
                    }
                }
                currentX += width + 5 + Math.random() * 20; // Binalar arasƒ± bo≈üluk
            }
        }

        // Zƒ±plama
        function jump() {
            if (doctor.grounded && gameRunning) {
                doctor.dy = doctor.jumpPower;
                doctor.grounded = false;
                createParticles(doctor.x + doctor.width/2, doctor.y + doctor.height, '#fff', 8);
            }
        }

        window.addEventListener('keydown', (e) => {
            if (e.code === 'Space' || e.code === 'ArrowUp') jump();
        });

        window.addEventListener('touchstart', (e) => {
            e.preventDefault(); 
            if(gameRunning) jump();
        }, {passive: false});
        
        window.addEventListener('mousedown', (e) => {
            if(gameRunning) jump();
        });

        document.getElementById('start-btn').addEventListener('click', startGame);
        document.getElementById('restart-btn').addEventListener('click', () => {
            gameOverScreen.style.display = 'none';
            startGame();
        });

        function startGame() {
            const name = document.getElementById('player-name-input').value.trim();
            if(!name) { alert("L√ºtfen bir isim girin!"); return; }
            startScreen.style.display = 'none';
            jumpHint.style.display = 'block';
            
            gameRunning = true;
            score = 0;
            gameSpeed = 6;
            obstacles = [];
            particles = [];
            doctor.y = groundHeight - doctor.height;
            doctor.dy = 0;
            doctor.grounded = true;
            frameCount = 0;
            buildings = [];
            generateBuildings();
            
            requestAnimationFrame(gameLoop);
        }

        function spawnObstacle() {
            const types = [
                { char: "ü¶†", width: 40, height: 40, yOffset: 0 },
                { char: "üíâ", width: 30, height: 60, yOffset: 0 },
                { char: "üõèÔ∏è", width: 70, height: 50, yOffset: 0 },
                { char: "üß™", width: 30, height: 40, yOffset: 0 }
            ];

            const type = types[Math.floor(Math.random() * types.length)];
            
            obstacles.push({
                x: canvas.width,
                y: groundHeight - type.height,
                width: type.width,
                height: type.height,
                char: type.char,
                passed: false
            });
        }

        function createParticles(x, y, color, count) {
            for(let i=0; i<count; i++) {
                particles.push({
                    x: x,
                    y: y,
                    vx: (Math.random() - 0.5) * 6,
                    vy: (Math.random() - 1) * 6,
                    life: 1.0,
                    color: color
                });
            }
        }

        function gameOver() {
            gameRunning = false;
            saveScore(score);
            finalScoreDisplay.innerText = Math.floor(score);
            gameOverScreen.style.display = 'flex';
            jumpHint.style.display = 'none';
        }

        function drawBackground() {
            // ≈ûeffaflƒ±k sorunu i√ßin reset
            ctx.globalAlpha = 1.0;

            // G√∂ky√ºz√º (Temizle)
            ctx.fillStyle = '#87CEEB';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Binalarƒ± √áiz ve Kaydƒ±r
            const buildingSpeed = gameSpeed * 0.5; // Paralaks efekt (daha yava≈ü)
            
            // Eƒüer binalar sola gidip kaybolursa, saƒüa yeni bina ekle
            if (buildings.length > 0 && buildings[0].x + buildings[0].w < -100) {
                buildings.shift(); // ƒ∞lk binayƒ± sil
                
                // En son binanƒ±n saƒüƒ±na yeni ekle
                const lastBuilding = buildings[buildings.length-1];
                let currentX = lastBuilding.x + lastBuilding.w + 10;
                
                const width = 80 + Math.random() * 100;
                const height = 150 + Math.random() * 200;
                const colors = ['#fecaca', '#bfdbfe', '#bbf7d0', '#ddd6fe', '#fde68a'];
                const color = colors[Math.floor(Math.random() * colors.length)];
                
                const newBuilding = {
                    x: currentX,
                    y: groundHeight - height,
                    w: width,
                    h: height,
                    color: color,
                    windows: []
                };
                 // Pencereleri olu≈ütur
                const floors = Math.floor(height / 40);
                const cols = Math.floor(width / 30);
                for(let f=0; f<floors; f++) {
                    for(let c=0; c<cols; c++) {
                        if(Math.random() > 0.3) {
                            newBuilding.windows.push({
                                x: 5 + c * 25,
                                y: 10 + f * 35,
                                w: 15, h: 20
                            });
                        }
                    }
                }
                buildings.push(newBuilding);
            }

            // Binalarƒ± √ßiz
            buildings.forEach(b => {
                b.x -= buildingSpeed; // Sola kaydƒ±r
                
                // Bina G√∂vdesi
                ctx.fillStyle = b.color;
                ctx.fillRect(b.x, b.y, b.w, b.h);
                
                // Bina √áatƒ±sƒ± (√ú√ßgen)
                ctx.beginPath();
                ctx.moveTo(b.x - 5, b.y);
                ctx.lineTo(b.x + b.w/2, b.y - 30);
                ctx.lineTo(b.x + b.w + 5, b.y);
                ctx.fillStyle = '#64748b'; // Koyu √ßatƒ±
                ctx.fill();

                // Pencereler
                ctx.fillStyle = '#e2e8f0'; // Kapalƒ± pencere
                b.windows.forEach(win => {
                    // Bazƒ± pencereler sarƒ± yansƒ±n (I≈üƒ±k)
                    if ((win.x + win.y) % 3 === 0) ctx.fillStyle = '#fef08a';
                    else ctx.fillStyle = '#334155';
                    ctx.fillRect(b.x + win.x, b.y + win.y, win.w, win.h);
                });
            });

            // Zemin (Yol)
            ctx.fillStyle = '#475569'; // Asfalt rengi
            ctx.fillRect(0, groundHeight, canvas.width, canvas.height - groundHeight);
            
            // Yol ≈ûeritleri
            ctx.fillStyle = '#fbbf24'; // Sarƒ± ≈üerit
            ctx.fillRect(0, groundHeight + 10, canvas.width, 5);
        }

        function gameLoop() {
            if (!gameRunning) return;

            // Her karede alpha resetle
            ctx.globalAlpha = 1.0;

            // Fizik
            frameCount++;
            gameSpeed += 0.002;
            score += 0.1;

            doctor.dy += doctor.gravity;
            doctor.y += doctor.dy;

            if (doctor.y + doctor.height > groundHeight) {
                doctor.y = groundHeight - doctor.height;
                doctor.dy = 0;
                doctor.grounded = true;
            } else {
                doctor.grounded = false;
            }

            if (frameCount % Math.floor(1800 / gameSpeed) === 0 || Math.random() < 0.005) {
                if (obstacles.length === 0 || (canvas.width - obstacles[obstacles.length-1].x > 350)) {
                    spawnObstacle();
                }
            }

            // √áizim Ba≈üla
            drawBackground();

            scoreDisplay.innerText = Math.floor(score);

            // Doktor √áizimi - G√ñR√úN√úRL√úK D√úZELTMESƒ∞
            
            // 1. G√∂lge (Ayak altƒ±)
            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.beginPath();
            ctx.ellipse(doctor.x + doctor.width/2, groundHeight + 5, doctor.width/1.5, 6, 0, 0, Math.PI*2);
            ctx.fill();

            // 2. Parlama / Hale (Karakterin arkasƒ±na)
            // A√ßƒ±k sarƒ± bir daire √ßizelim ki karakter g√∂ky√ºz√ºnde kaybolmasƒ±n
            ctx.shadowBlur = 20;
            ctx.shadowColor = 'rgba(255, 255, 255, 0.8)';
            ctx.fillStyle = 'rgba(255, 255, 255, 0.6)'; // Yarƒ± saydam beyaz arka ƒ±≈üƒ±k
            ctx.beginPath();
            ctx.arc(doctor.x + doctor.width/2, doctor.y + doctor.height/1.8, 35, 0, Math.PI*2);
            ctx.fill();
            ctx.shadowBlur = 0; // Shadow reset

            // 3. Karakter (Emoji)
            ctx.font = `bold ${doctor.height}px Arial`;
            ctx.textAlign = "center";
            ctx.textBaseline = "bottom";
            
            let bounce = 0;
            if(doctor.grounded) bounce = Math.sin(frameCount * 0.5) * 5;

            ctx.save();
            // Zƒ±plama a√ßƒ±sƒ±
            if(!doctor.grounded) {
                ctx.translate(doctor.x + doctor.width/2, doctor.y + doctor.height);
                ctx.rotate(-0.15); 
                ctx.translate(-(doctor.x + doctor.width/2), -(doctor.y + doctor.height));
            }
            
            // Karakteri √ßiz
            const charX = doctor.x + doctor.width/2;
            const charY = doctor.y + doctor.height - bounce;
            
            // Kontur ekle (Daha belirgin olmasƒ± i√ßin)
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 3;
            ctx.strokeText(doctor.sprite, charX, charY);
            
            // ƒ∞√ßini doldur
            ctx.fillStyle = '#000'; // Emoji rengi (tarayƒ±cƒ± y√∂netir ama fillStyle gerekir)
            ctx.fillText(doctor.sprite, charX, charY);
            
            ctx.restore();

            // Engeller
            for(let i = 0; i < obstacles.length; i++) {
                let obs = obstacles[i];
                obs.x -= gameSpeed;

                ctx.font = `${obs.height}px Arial`;
                // Engel i√ßin de hafif kontur
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.strokeText(obs.char, obs.x + obs.width/2, obs.y + obs.height);
                ctx.fillText(obs.char, obs.x + obs.width/2, obs.y + obs.height);

                const padding = 12;
                if (
                    doctor.x + padding < obs.x + obs.width - padding &&
                    doctor.x + doctor.width - padding > obs.x + padding &&
                    doctor.y + padding < obs.y + obs.height - padding &&
                    doctor.y + doctor.height - padding > obs.y + padding
                ) {
                    createParticles(doctor.x, doctor.y, '#ef4444', 20);
                    gameOver();
                    return; 
                }

                if (obs.x + obs.width < 0) {
                    obstacles.splice(i, 1);
                    i--;
                    score += 10; 
                }
            }

            // Par√ßacƒ±klar
            particles.forEach((p, i) => {
                p.x += p.vx;
                p.y += p.vy;
                p.life -= 0.02;
                if (p.life <= 0) particles.splice(i, 1);
                else {
                    ctx.globalAlpha = p.life;
                    ctx.fillStyle = p.color;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, 4, 0, Math.PI*2);
                    ctx.fill();
                    ctx.globalAlpha = 1.0;
                }
            });

            requestAnimationFrame(gameLoop);
        }
        
        // ƒ∞lk a√ßƒ±lƒ±≈üta binalarƒ± olu≈ütur
        resize();

    </script>
</body>
</html>